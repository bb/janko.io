<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Shrine 2.0 Released | Janko's Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="Shrine 2.0 Released" />
<meta name="author" content="Janko Marohnić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Shrine is a full-featured library for handling file uploads in Ruby applications. Main advantages of Shrine are good design, loads of flexibility for achieving maximum performance and best user experience for any use case, and advanced features like backgrounding, direct uploads, logging and more." />
<meta property="og:description" content="Shrine is a full-featured library for handling file uploads in Ruby applications. Main advantages of Shrine are good design, loads of flexibility for achieving maximum performance and best user experience for any use case, and advanced features like backgrounding, direct uploads, logging and more." />
<link rel="canonical" href="https://janko.io/shrine-2-0-released/" />
<meta property="og:url" content="https://janko.io/shrine-2-0-released/" />
<meta property="og:site_name" content="Janko’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-05-20T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Shrine 2.0 Released" />
<meta name="twitter:site" content="@jankomarohnic" />
<meta name="twitter:creator" content="@jankomarohnic" />
<meta property="article:publisher" content="https://www.facebook.com/janko.marohnic/" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Shrine 2.0 Released","dateModified":"2016-05-20T00:00:00+02:00","description":"Shrine is a full-featured library for handling file uploads in Ruby applications. Main advantages of Shrine are good design, loads of flexibility for achieving maximum performance and best user experience for any use case, and advanced features like backgrounding, direct uploads, logging and more.","datePublished":"2016-05-20T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://janko.io/shrine-2-0-released/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://janko.io/images/logo.png"},"name":"Janko Marohnić"},"url":"https://janko.io/shrine-2-0-released/","author":{"@type":"Person","name":"Janko Marohnić"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="https://janko.io/feed.xml" title="Janko&apos;s Blog" />
    <link rel="stylesheet" href="/css/bundle.css">
  </head>

  <body class="text-xl text-gray-700">
    <header class="py-3 px-4 flex flex-col space-y-1 bg-gray-100 border-b">
      <div class="flex justify-center">
        <a class="flex items-center space-x-2" href="/">
          <img class="h-8" src="/images/logo.png" alt="logo" />
          <span class="text-2xl md:text-3xl font-semibold text-pink-700">Janko's Blog</span>
        </a>
      </div>
      <div class="flex justify-center">
        <span class="text-base md:text-lg text-gray-500">Sharing the wonders of Ruby</p>
      </div>
    </header>

    <div class="text-center py-3 px-4 bg-sky-50 border-b border-sky-100 text-sky-600 text-base md:text-md lg:text-lg">
      Dear Russian friends, please watch President Zelenskyy's <a href="https://www.youtube.com/watch?v=p-zilnPtZ2M" class="underline text-blue-600 hover:text-blue-500">speech addressed to you</a>.
      🇺🇦 Support Ukraine by <a href="https://war.ukraine.ua/support-ukraine/" class="underline text-yellow-600 hover:text-yellow-500">donating</a> to humanitarian aid.
    </div>

    <div class="my-6 sm:my-8 mx-4">
      <main class="max-w-screen-sm md:max-w-screen-md mx-auto">
        <article>
  <header class="space-y-4 md:space-y-5">
    <h1 class="lg:-mx-28 text-3xl sm:text-4xl lg:text-5xl text-center font-medium text-gray-900">Shrine 2.0 Released</h1>

    <div class="flex justify-center">
      <div class="flex flex-col items-center sm:flex-row sm:items-baseline space-y-3 sm:space-y-0 sm:space-x-4 text-sm md:text-base">
        <span class="text-gray-500">
          By <a class="underline hover:text-gray-700" href="/about">Janko Marohnić</a> on
          <time datetime="2016-05-20 00:00:00 +0200">
            20 May 2016
          </time>
        </span>
        
          
<a class="my-1 rounded-full px-3 bg-red-100 text-red-700 font-semibold py-0.5" href="/shrine">shrine</a>


        
      </div>
    </div>
  </header>

  <div class="mt-4 sm:mt-6 markdown">
    <p><a href="https://github.com/shrinerb/shrine">Shrine</a> is a full-featured library for handling file uploads in Ruby
applications. Main advantages of Shrine are <a href="http://shrinerb.com/rdoc/files/doc/design_md.html">good design</a>, loads of flexibility
for achieving maximum performance and best user experience for any use case, and
advanced features like backgrounding, direct uploads, logging and more.</p>

<p>In this post I would like show you some of the most notable improvements since
version 1.0.</p>

<h2 id="storages--plugins">Storages &amp; Plugins</h2>

<p>Apart from <a href="http://shrinerb.com/rdoc/classes/Shrine/Storage/FileSystem.html">FileSystem</a> and <a href="http://shrinerb.com/rdoc/classes/Shrine/Storage/S3.html">S3</a> storages that ship with Shrine, there are now
<a href="https://github.com/shrinerb/shrine-cloudinary">Cloudinary</a>, <a href="https://github.com/shrinerb/shrine-imgix">Imgix</a>, <a href="https://github.com/shrinerb/shrine-flickr">Flickr</a>, <a href="https://github.com/shrinerb/shrine-fog">Fog</a>, <a href="https://github.com/shrinerb/shrine-fog">GridFS</a>, <a href="https://github.com/shrinerb/shrine-memory">Memory</a>, and <a href="https://github.com/shrinerb/shrine-sql">SQL</a> storages
that can be used with Shrine.</p>

<p>Apart from <a href="http://shrinerb.com/rdoc/classes/Shrine/Plugins/Sequel.html">Sequel</a> and <a href="http://shrinerb.com/rdoc/classes/Shrine/Plugins/Activerecord.html">ActiveRecord</a> integrations that ship with Shrine,
there are now integrations for <a href="https://github.com/shrinerb/shrine-mongoid">Mongoid</a>, <a href="https://github.com/katafrakt/hanami-shrine">Hanami</a> and <a href="https://github.com/shrinerb/shrine-reform">Reform</a> as well.</p>

<p>Since Shrine has good abstractions, both storage classes and plugins are very
easy to write. There are even guides for <a href="http://shrinerb.com/rdoc/files/doc/creating_storages_md.html">creating storages</a> and <a href="http://shrinerb.com/rdoc/files/doc/creating_plugins_md.html">creating
plugins</a>.</p>

<h2 id="upload-options">Upload options</h2>

<p>Storages like S3 and Cloudinary support a variety of options when uploading
files. With S3 you can choose public/private, expiration, caching, while
with Cloudinary you can choose responsive breakpoints, transformations,
face detection and other.</p>

<p>The simplest way to set upload options is directly on the storage:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Shrine</span><span class="o">::</span><span class="no">Storage</span><span class="o">::</span><span class="no">Cloudinary</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
  <span class="ss">upload_options: </span><span class="p">{</span>
    <span class="ss">responsive_breakpoints: </span><span class="p">{</span>
      <span class="ss">min_width: </span><span class="mi">200</span><span class="p">,</span>
      <span class="ss">max_width: </span><span class="mi">1000</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="o">**</span><span class="n">options</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Shrine also ships with <a href="http://shrinerb.com/rdoc/classes/Shrine/Plugins/UploadOptions.html">upload_options</a> plugin which allows you to set upload
options dynamically:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plugin</span> <span class="ss">:upload_options</span><span class="p">,</span> <span class="ss">store: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="ss">:version</span><span class="p">]</span> <span class="o">==</span> <span class="ss">:original</span>
    <span class="p">{</span><span class="ss">acl: </span><span class="s2">"private"</span><span class="p">}</span> <span class="c1"># the original file is private</span>
  <span class="k">else</span>
    <span class="p">{</span><span class="ss">acl: </span><span class="s2">"public-read"</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="metadata">Metadata</h2>

<p>With Shrine it’s really easy to extract metadata of uploaded files; by default
Shrine extracts filesize, original filename and MIME type, and saves it to the
<code class="language-plaintext highlighter-rouge">&lt;attachment&gt;_data</code> column as JSON.</p>

<p>Shrine also has <a href="http://shrinerb.com/rdoc/classes/Shrine/Plugins/DetermineMimeType.html">determine_mime_type</a> plugin for determining MIME type from file
contents, and <a href="http://shrinerb.com/rdoc/classes/Shrine/Plugins/StoreDimensions.html">store_dimensions</a> plugin for extracting image dimensions. From
Shrine 2.0 you are now able to combine built-in analyzers:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plugin</span> <span class="ss">:determine_mime_type</span><span class="p">,</span> <span class="ss">analyzer: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">analyzers</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">analyzers</span><span class="p">[</span><span class="ss">:mimemagic</span><span class="p">].</span><span class="nf">call</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="o">||</span> <span class="n">analyzers</span><span class="p">[</span><span class="ss">:file</span><span class="p">].</span><span class="nf">call</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The above first attempts to determine file’s MIME type with <a href="https://github.com/minad/mimemagic">MimeMagic</a>, and
falls back to the <a href="http://linux.die.net/man/1/file">file command</a>.</p>

<h2 id="download-endpoint">Download endpoint</h2>

<p>If you’re storing files in an SQL or Mongo database, or you’re caching files in
the tmp/ directory because Heroku doesn’t allow you to write into the public/
directory, your files won’t be accessible via URL.</p>

<p>Or you may want that all uploaded file URLs go through your application
(regardless of where they’re stored), so that you can require authentication
for those files.</p>

<p>To cover both scenarios Shrine now has the <a href="http://shrinerb.com/rdoc/classes/Shrine/Plugins/DownloadEndpoint.html">download_endpoint</a> plugin. This
plugin provides a Rack endpoint which you can mount inside your application,
which streams uploaded files. It’s even smart enough to set the
“Content-Length” response header, so that browsers can show an ETA.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">VideoUploader</span> <span class="o">&lt;</span> <span class="no">Shrine</span>
  <span class="n">plugin</span> <span class="ss">:download_endpoint</span><span class="p">,</span> <span class="ss">storages: </span><span class="p">[</span><span class="ss">:store</span><span class="p">],</span> <span class="ss">prefix: </span><span class="s2">"videos"</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">mount</span> <span class="no">VideoUploader</span><span class="o">::</span><span class="no">DownloadEndpoint</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"/videos"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If your files are stored on a remote storage like S3, the endpoint will
<strong>stream the file as it is being downloaded</strong>. I’ve tested this with a video
uploaded to S3, and through this enpdoint I could start watching it already
after 3 seconds, even though most of the video hasn’t yet been downloaded from
S3.</p>

<h2 id="backups">Backups</h2>

<p>You may want the uploaded files to be automatically backed up. Some cloud
services have this feature built-in, but some don’t. For that reason Shrine
provides a generic <a href="http://shrinerb.com/rdoc/classes/Shrine/Plugins/Backup.html">backup</a> plugin which automatically backs up files uploaded
to the main storage, to any other Shrine storage.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">storages</span><span class="p">[</span><span class="ss">:s3_backup</span><span class="p">]</span> <span class="o">=</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">Storage</span><span class="o">::</span><span class="no">S3</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">bucket: </span><span class="s2">"myapp-backup"</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
<span class="n">plugin</span> <span class="ss">:backup</span><span class="p">,</span> <span class="ss">storage: :s3_backup</span>
</code></pre></div></div>

<h2 id="callbacks">Callbacks</h2>

<p>Sometimes you may want to do additional actions when attachment is cached
(uploaded to temporary storage) or stored (uploaded to permanent storage).
Shrine now provides <code class="language-plaintext highlighter-rouge">Attacher#cached?</code> and <code class="language-plaintext highlighter-rouge">Attacher#stored?</code> methods which you
can use in callbacks:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Document</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span>
  <span class="kp">include</span> <span class="no">FileUploader</span><span class="o">::</span><span class="no">Attachment</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:file</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">before_save</span>
    <span class="k">super</span>
    <span class="k">if</span> <span class="n">column_changed?</span><span class="p">(</span><span class="ss">:file_data</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">file_attacher</span><span class="p">.</span><span class="nf">cached?</span>
        <span class="c1"># ...</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">file_attacher</span><span class="p">.</span><span class="nf">stored?</span>
        <span class="c1"># ...</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="testing">Testing</h2>

<p>Shrine provides a “direct upload” feature, which allows you to asynchronously
start caching the file as soon as the user chooses it in the form. For S3
storage you can upload the file directly to Amazon, and these are called
“presigned uploads”.</p>

<p>If you were writing acceptance tests around presigned uploads, and you wanted
files to be uploaded to FileSystem rather than S3 in order to avoid HTTP
requests in tests, you needed to create special “test” conditionals in your
application code.</p>

<p>As of Shrine 1.4.0, you don’t need to make any additional setup when testing
presigns, using FileSystem will just work.</p>

<h2 id="switching">Switching</h2>

<p>If you ever decide you want to switch to Shrine from an existing file upload
library, I wrote guides for <a href="http://shrinerb.com/rdoc/files/doc/carrierwave_md.html">CarrierWave</a>, <a href="http://shrinerb.com/rdoc/files/doc/paperclip_md.html">Paperclip</a> and <a href="http://shrinerb.com/rdoc/files/doc/refile_md.html">Refile</a> users.
The guides explain some of the key differences in how Shrine works compared to
the other libraries, following with a detailed 1-1 mapping of features, and
complete instructions on how to migrate a production app to Shrine.</p>

<h2 id="future">Future</h2>

<p>While you don’t need any Shrine-specific gems to process files in Shrine, the
<a href="https://github.com/janko/image_processing">image_processing</a> gem is a convenient collection of high-level macros for
common image processing requirements. Currently it only supports <a href="https://github.com/minimagick/minimagick">MiniMagick</a>,
but I would like to add support for <a href="http://www.vips.ecs.soton.ac.uk/">VIPS</a>, and perhaps <a href="https://github.com/rmagick/rmagick">RMagick</a> since it’s now
<a href="http://linduxed.com/blog/2015/07/19/rmagick-a-year-later/">revived</a>.</p>

<p>I also plan to create Shrine integrations for other on-the-fly processing
services like <a href="https://www.filestack.com/">FileStack</a> and <a href="https://uploadcare.com/">Uploadcare</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I’mv very happy with the way Shrine is going, I think it’s successfully
addressing the limitations of existing file upload libraries, and provides some
nice unique features.</p>


  </div>
</article>

<div class="mt-8 md:mt-10">
  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'twinblog'; // required: replace example with your forum shortname
    var disqus_identifier = '/shrine-2-0-released';
    var disqus_url = 'https://janko.io/shrine-2-0-released/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</div>

      </main>
    </div>

    
      <!-- Fathom - beautiful, simple website analytics -->
<script src="https://bouncy-van.janko.io/script.js" data-site="EKJCVCTX" defer></script>
<!-- / Fathom -->

    
  </body>
</html>
