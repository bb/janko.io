<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Shrine 3.0 Released | Janko's Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Shrine 3.0 Released" />
<meta name="author" content="Janko Marohnić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’ve just released version 3.0 of Shrine, a gem for handling file attachments in Ruby applications. It’s been months of hard work, but I feel it’s finally ready." />
<meta property="og:description" content="I’ve just released version 3.0 of Shrine, a gem for handling file attachments in Ruby applications. It’s been months of hard work, but I feel it’s finally ready." />
<link rel="canonical" href="https://janko.io/shrine-3-0-released/" />
<meta property="og:url" content="https://janko.io/shrine-3-0-released/" />
<meta property="og:site_name" content="Janko’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-14T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Shrine 3.0 Released" />
<meta name="twitter:site" content="@jankomarohnic" />
<meta name="twitter:creator" content="@jankomarohnic" />
<meta property="article:publisher" content="https://www.facebook.com/janko.marohnic/" />
<script type="application/ld+json">
{"headline":"Shrine 3.0 Released","dateModified":"2019-10-14T00:00:00+02:00","datePublished":"2019-10-14T00:00:00+02:00","url":"https://janko.io/shrine-3-0-released/","mainEntityOfPage":{"@type":"WebPage","@id":"https://janko.io/shrine-3-0-released/"},"author":{"@type":"Person","name":"Janko Marohnić"},"@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://janko.io/images/logo.png"},"name":"Janko Marohnić"},"description":"I’ve just released version 3.0 of Shrine, a gem for handling file attachments in Ruby applications. It’s been months of hard work, but I feel it’s finally ready.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="https://janko.io/feed.xml" title="Janko&apos;s Blog" />
    <link rel="stylesheet" href="/css/bundle.css">
  </head>

  <body class="text-xl text-gray-700">
    <header class="py-3 px-4 flex flex-col space-y-1 bg-gray-100 border-b">
      <div class="flex justify-center">
        <a class="flex items-center space-x-2" href="/">
          <img class="h-8" src="/images/logo.png" alt="logo">
          <span class="text-2xl md:text-3xl font-semibold text-pink-700">Janko's Blog</span>
        </a>
      </div>
      <div class="flex justify-center">
        <span class="text-base md:text-lg text-gray-500">Sharing the wonders of Ruby
      </span>
</div>
    </header>

    <div class="my-6 sm:my-8 mx-4">
      <main class="max-w-screen-sm md:max-w-screen-md mx-auto">
        <article>
  <header class="space-y-4 md:space-y-5">
    <h1 class="lg:-mx-28 text-3xl sm:text-4xl lg:text-5xl text-center font-medium text-gray-900">Shrine 3.0 Released</h1>

    <div class="flex justify-center">
      <div class="flex flex-col items-center sm:flex-row sm:items-baseline space-y-3 sm:space-y-0 sm:space-x-4 text-sm md:text-base">
        <span class="text-gray-500">
          By <a class="underline hover:text-gray-700" href="/about">Janko Marohnić</a> on
          <time datetime="2019-10-14 00:00:00 +0200">
            14 Oct 2019
          </time>
        </span>
        
          
<a class="my-1 rounded-full px-3 bg-red-100 text-red-700 font-semibold py-0.5" href="/shrine">shrine</a>


        
      </div>
    </div>
  </header>

  <div class="mt-4 sm:mt-6 markdown">
    <p>I’ve just released version 3.0 of <a href="https://shrinerb.com">Shrine</a>, a gem for handling file attachments
in Ruby applications. It’s been months of hard work, but I feel it’s finally
ready.</p>

<h2 id="redesigned-website">Redesigned website</h2>

<p>The old Jekyll website has been <a href="https://github.com/shrinerb/shrine/pull/419">rewritten</a> to use
<strong><a href="http://docusaurus.io">Docusaurus</a></strong>. <img class="emoji" title=":sparkles:" alt=":sparkles:" src="https://github.githubassets.com/images/icons/emoji/unicode/2728.png" height="20" width="20"></p>

<p><a href="https://shrinerb.com"><img src="/images/shrine-website.png" alt="Shrine new website"></a></p>

<p>Docusaurus gives us nice features such as sidebars with autogenerated TOC and
related documents, which greatly improve navigation experience.</p>

<p><a href="https://shrinerb.com/docs/getting-started"><img src="/images/shrine-website-sidebars.png" alt="Shrine website sidebars"></a></p>

<p>We also now have a snippet switcher, which makes it easier to show code for
different libraries.</p>

<div>
  <img src="/images/shrine-website-switcher-a.png" alt="Shrine website snippet switcher A" width="600">
  <img src="/images/shrine-website-switcher-b.png" alt="Shrine website snippet switcher B" width="600">
  <img src="/images/shrine-website-switcher-c.png" alt="Shrine website snippet switcher C" width="600">
</div>

<p>Last but not least, we now have a documentation search bar powered by <a href="https://community.algolia.com/docsearch/">Algolia
DocSearch</a>.</p>

<p><img src="/images/shrine-website-search.png" alt="Shrine website search"></p>

<h2 id="major-features">Major features</h2>

<p>I’ve talked about the major changes in more detail <a href="/upcoming-features-in-shrine-3-0/">Upcoming Features in Shrine
3.0</a>, but I’ll give a brief overview here.</p>

<h3 id="attacher-redesign">Attacher redesign</h3>

<p>The <a href="https://shrinerb.com/docs/attacher"><code class="language-plaintext highlighter-rouge">Shrine::Attacher</code></a> class has been decoupled from the Active
Record pattern. It now supports handling attachments for immutable structs
(which are commonly used in Hanami, ROM, and dry-rb):</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">Hanami</span><span class="o">::</span><span class="no">Entity</span> <span class="c1"># immutable struct</span>
  <span class="kp">include</span> <span class="no">ImageUploader</span><span class="o">::</span><span class="no">Attachment</span><span class="p">(</span><span class="ss">:image</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span> <span class="o">=</span> <span class="n">photo_repository</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">photo_id</span><span class="p">)</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="c1">#=&gt; #&lt;Shrine::UploadedFile&gt;</span>

<span class="n">attacher</span> <span class="o">=</span> <span class="n">photo</span><span class="p">.</span><span class="nf">image_attacher</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1"># attach new file</span>

<span class="n">photo_repository</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">photo_id</span><span class="p">,</span> <span class="p">{</span> <span class="ss">image_data: </span><span class="n">attacher</span><span class="p">.</span><span class="nf">column_data</span> <span class="p">})</span>
</code></pre></div></div>

<p>It can also be used standalone:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">attacher</span> <span class="o">=</span> <span class="no">ImageUploader</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">new</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">file</span> <span class="c1">#=&gt; #&lt;Shrine::UploadedFile&gt;</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">url</span>  <span class="c1">#=&gt; "https://my-bucket.s3.amazonaws.com/path/to/image.jpg"</span>
</code></pre></div></div>

<h3 id="versions-rewrite">Versions rewrite</h3>

<p>The <code class="language-plaintext highlighter-rouge">versions</code> plugin is used for storing processed files alongside the main
file. Its implementation had many limitations, such as being coupled to the
attachment flow, mixing processed files and original file together, not being
able to specify different storage for processed files etc.</p>

<p>The new <strong><a href="https://shrinerb.com/docs/plugins/derivatives">derivatives</a></strong> plugin is a rewrite of <code class="language-plaintext highlighter-rouge">versions</code>, offering an
explicit interface and the much needed flexibility.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:derivatives</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">Shrine</span>
  <span class="no">Attacher</span><span class="p">.</span><span class="nf">derivatives_processor</span> <span class="k">do</span> <span class="o">|</span><span class="n">original</span><span class="o">|</span>
    <span class="n">magick</span> <span class="o">=</span> <span class="no">ImageProcessing</span><span class="o">::</span><span class="no">MiniMagick</span><span class="p">.</span><span class="nf">source</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>

    <span class="p">{</span> <span class="ss">large:  </span><span class="n">magick</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span>
      <span class="ss">medium: </span><span class="n">magick</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
      <span class="ss">small:  </span><span class="n">magick</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Processing is now triggered explicitly:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">image: </span><span class="n">file</span><span class="p">)</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image_derivatives!</span> <span class="c1"># calls derivatives processor</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">save</span>
</code></pre></div></div>

<p>And processed data is saved separately from the original file:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span><span class="p">.</span><span class="nf">image</span>             <span class="c1">#=&gt; #&lt;Shrine::UploadedFile @id="30733d04faceec5b.jpg" ...&gt;</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image_derivatives</span> <span class="c1">#=&gt;</span>
<span class="c1"># { large:  #&lt;Shrine::UploadedFile @id="86500abe387b20b1.jpg" ...&gt;,</span>
<span class="c1">#   medium: #&lt;Shrine::UploadedFile @id="9e46ffbcca548290.jpg" ...&gt;,</span>
<span class="c1">#   small:  #&lt;Shrine::UploadedFile @id="f80fb04c3627c5a5.jpg" ...&gt;, }</span>
</code></pre></div></div>

<h3 id="mirroring">Mirroring</h3>

<p>The <strong><a href="https://shrinerb.com/docs/plugins/mirroring">mirroring</a></strong> plugin has been added, which allows replicating uploads and
deletes to additional storage services. It’s inspired by Active Storage and its
<a href="https://guides.rubyonrails.org/active_storage_overview.html#mirror-service">mirror service</a>.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Shrine</span><span class="p">.</span><span class="nf">storages</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">cache: </span><span class="no">Shrine</span><span class="o">::</span><span class="no">Storage</span><span class="o">::</span><span class="no">S3</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">prefix: </span><span class="s2">"cache"</span><span class="p">,</span> <span class="o">**</span><span class="n">s3_options</span><span class="p">),</span>
  <span class="ss">store: </span><span class="no">Shrine</span><span class="o">::</span><span class="no">Storage</span><span class="o">::</span><span class="no">S3</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">**</span><span class="n">s3_options</span><span class="p">),</span>
  <span class="ss">gcs:   </span><span class="no">Shrine</span><span class="o">::</span><span class="no">Storage</span><span class="o">::</span><span class="no">GoogleCloudStorage</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">**</span><span class="n">gcs_options</span><span class="p">),</span>
<span class="p">}</span>

<span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:mirroring</span><span class="p">,</span> <span class="ss">mirror: </span><span class="p">{</span> <span class="ss">store: :gcs</span> <span class="p">}</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">image: </span><span class="n">file</span><span class="p">)</span> <span class="c1"># uploads main file to S3 and GCS</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image_derivatives!</span>          <span class="c1"># uploads processed files to S3 and GCS</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">destroy</span>                     <span class="c1"># deletes files from S3 and GCS</span>
</code></pre></div></div>

<p>You can also separate the mirroring operations into <a href="https://shrinerb.com/docs/plugins/mirroring#backgrounding">background
jobs</a>, so that they don’t slow down the attachment
flow.</p>

<h2 id="changes">Changes</h2>

<p>For the full list of changes, see the <a href="https://shrinerb.com/docs/release_notes/3.0.0">release notes</a>. If you’re currently on
Shrine 2.x, there is a detailed <a href="https://shrinerb.com/docs/upgrading-to-3">guide</a> for upgrading to
Shrine 3.x.</p>

<h3 id="plugins">Plugins</h3>

<p>The following plugins have been added <img class="emoji" title=":gift:" alt=":gift:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f381.png" height="20" width="20">:</p>

<ul>
  <li><a href="https://shrinerb.com/docs/plugins/derivatives">derivatives</a></li>
  <li><a href="https://shrinerb.com/docs/plugins/atomic_helpers">atomic_helpers</a></li>
  <li><a href="https://shrinerb.com/docs/plugins/model">model</a></li>
  <li><a href="https://shrinerb.com/docs/plugins/entity">entity</a></li>
  <li><a href="https://shrinerb.com/docs/plugins/column">column</a></li>
  <li><a href="https://shrinerb.com/docs/plugins/mirroring">mirroring</a></li>
  <li><a href="https://shrinerb.com/docs/plugins/multi_cache">multi_cache</a></li>
  <li><a href="https://shrinerb.com/docs/plugins/validation">validation</a></li>
  <li><a href="https://shrinerb.com/docs/plugins/form_assign">form_assign</a></li>
</ul>

<p>The following plugins have been deprecated <img class="emoji" title=":hand:" alt=":hand:" src="https://github.githubassets.com/images/icons/emoji/unicode/270b.png" height="20" width="20">:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">versions</code></li>
  <li><code class="language-plaintext highlighter-rouge">processing</code></li>
  <li><code class="language-plaintext highlighter-rouge">recache</code></li>
  <li><code class="language-plaintext highlighter-rouge">delete_raw</code></li>
  <li><code class="language-plaintext highlighter-rouge">module_include</code></li>
</ul>

<p>The following plugins have been removed <img class="emoji" title=":scissors:" alt=":scissors:" src="https://github.githubassets.com/images/icons/emoji/unicode/2702.png" height="20" width="20">:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">logging</code></li>
  <li><code class="language-plaintext highlighter-rouge">moving</code></li>
  <li><code class="language-plaintext highlighter-rouge">copy</code></li>
  <li><code class="language-plaintext highlighter-rouge">backup</code></li>
  <li><code class="language-plaintext highlighter-rouge">hooks</code></li>
  <li><code class="language-plaintext highlighter-rouge">parallelize</code></li>
  <li><code class="language-plaintext highlighter-rouge">parsed_json</code></li>
  <li><code class="language-plaintext highlighter-rouge">delete_promoted</code></li>
  <li><code class="language-plaintext highlighter-rouge">multi_delete</code></li>
  <li><code class="language-plaintext highlighter-rouge">direct_upload</code></li>
  <li><code class="language-plaintext highlighter-rouge">background_helpers</code></li>
  <li><code class="language-plaintext highlighter-rouge">migration_helpers</code></li>
</ul>

<h3 id="gems">Gems</h3>

<p>All official <code class="language-plaintext highlighter-rouge">shrine-*</code> gems have been updated to work with Shrine 3.0:</p>

<ul>
  <li><a href="https://github.com/shrinerb/shrine-cloudinary">shrine-cloudinary</a></li>
  <li><a href="https://github.com/shrinerb/shrine-flickr">shrine-flickr</a></li>
  <li><a href="https://github.com/shrinerb/shrine-fog">shrine-fog</a></li>
  <li><a href="https://github.com/shrinerb/shrine-gridfs">shrine-gridfs</a></li>
  <li><a href="https://github.com/shrinerb/shrine-imgix">shrine-imgix</a></li>
  <li><a href="https://github.com/shrinerb/shrine-mongoid">shrine-mongoid</a></li>
  <li><a href="https://github.com/shrinerb/shrine-sql">shrine-sql</a></li>
  <li><a href="https://github.com/shrinerb/shrine-transloadit">shrine-transloadit</a></li>
  <li><a href="https://github.com/shrinerb/shrine-tus">shrine-tus</a></li>
  <li><a href="https://github.com/shrinerb/shrine-uploadcare">shrine-uploadcare</a></li>
  <li><a href="https://github.com/shrinerb/shrine-url">shrine-url</a></li>
</ul>

<h3 id="rom--hanami-integration">ROM &amp; Hanami integration</h3>

<p>As a result of the attacher redesign, Shrine 3.0 should now integrate better
with ROM and Hanami. I’m still wrapping up the <a href="https://github.com/shrinerb/shrine-rom">shrine-rom</a> gem, it should
hopefully get released in the next couple of days. <img class="emoji" title=":crossed_fingers:" alt=":crossed_fingers:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f91e.png" height="20" width="20"></p>

<h2 id="conclusion">Conclusion</h2>

<p>This has been the biggest Shrine release so far <img class="emoji" title=":open_mouth:" alt=":open_mouth:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f62e.png" height="20" width="20">. Shrine has been
on 2.x for the past three years, and during that time it became obvious that
some features weren’t well designed.</p>

<p>Shrine’s plugin architecture helped us a lot in addressing these, as it kept
features largely decoupled from one another. This made it easier to identify
issues and make changes, as we could work on one feature without affecting
others.</p>

<p>Let me know if you have any feedback. Feel free to post on our <a href="https://discourse.shrinerb.com/">Discourse
forum</a> if you have any troubles upgrading.</p>


  </div>
</article>

<div class="mt-8 md:mt-10">
  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'twinblog'; // required: replace example with your forum shortname
    var disqus_identifier = '/shrine-3-0-released';
    var disqus_url = 'https://janko.io/shrine-3-0-released/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</div>

      </main>
    </div>

    
      <script>
  // Gauges
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '51f5bd47f5a1f545ac0000fc');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>

    
  </body>
</html>
