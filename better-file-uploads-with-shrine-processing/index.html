<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Better File Uploads with Shrine: Processing | Janko's Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="Better File Uploads with Shrine: Processing" />
<meta name="author" content="Janko Marohnić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is the 4th part of a series of blog posts about Shrine. In this part I talk about doing file processing with Shrine, both on upload and on-the-fly." />
<meta property="og:description" content="This is the 4th part of a series of blog posts about Shrine. In this part I talk about doing file processing with Shrine, both on upload and on-the-fly." />
<link rel="canonical" href="https://janko.io/better-file-uploads-with-shrine-processing/" />
<meta property="og:url" content="https://janko.io/better-file-uploads-with-shrine-processing/" />
<meta property="og:site_name" content="Janko’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-10-31T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Better File Uploads with Shrine: Processing" />
<meta name="twitter:site" content="@jankomarohnic" />
<meta name="twitter:creator" content="@jankomarohnic" />
<meta property="article:publisher" content="https://www.facebook.com/janko.marohnic/" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://janko.io/better-file-uploads-with-shrine-processing/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://janko.io/images/logo.png"},"name":"Janko Marohnić"},"author":{"@type":"Person","name":"Janko Marohnić"},"headline":"Better File Uploads with Shrine: Processing","dateModified":"2016-10-31T00:00:00+01:00","datePublished":"2016-10-31T00:00:00+01:00","description":"This is the 4th part of a series of blog posts about Shrine. In this part I talk about doing file processing with Shrine, both on upload and on-the-fly.","url":"https://janko.io/better-file-uploads-with-shrine-processing/","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="https://janko.io/feed.xml" title="Janko&apos;s Blog" />
    <link rel="stylesheet" href="/css/bundle.css">
  </head>

  <body class="text-xl text-gray-700 dark:bg-slate-900 dark:text-gray-400">
    <header class="py-3 px-4 flex flex-col space-y-1 bg-gray-100 border-b dark:bg-gray-800/70 dark:border-sky-300">
      <div class="flex justify-center">
        <a class="flex items-center space-x-2" href="/">
          <img class="h-8" src="/images/logo.png" alt="logo" />
          <span class="text-2xl md:text-3xl font-semibold text-pink-700 dark:text-pink-500">Janko's Blog</span>
        </a>
      </div>
    </header>

    <div class="my-6 sm:my-8 mx-4">
      <main class="max-w-screen-sm md:max-w-screen-md mx-auto">
        <article>
  <header class="space-y-4 md:space-y-5">
    <h1 class="lg:-mx-28 text-3xl sm:text-4xl lg:text-5xl text-center font-medium text-gray-900 dark:text-gray-100">Better File Uploads with Shrine: Processing</h1>

    <div class="flex justify-center">
      <div class="flex flex-col items-center sm:flex-row sm:items-baseline space-y-3 sm:space-y-0 sm:space-x-4 text-sm md:text-base">
        <span class="text-gray-500 dark:text-gray-400">
          By <a class="underline hover:text-gray-300" href="/about">Janko Marohnić</a> on
          <time datetime="2016-10-31 00:00:00 +0100">
            31 Oct 2016
          </time>
        </span>
        
          
<a class="my-1 rounded-full px-3 bg-red-100 text-red-700 font-semibold py-0.5 dark:bg-red-900 dark:text-red-300" href="/shrine">shrine</a>


        
      </div>
    </div>
  </header>

  <div class="mt-4 sm:mt-6 markdown">
    <p>Whenever we accept file uploads, we usually want to apply some processing
to the files before storing them to permanent storage. We might want to</p>

<ul>
  <li>generate image thumbnails</li>
  <li>optimize images</li>
  <li>transcode videos</li>
  <li>extract video screenshots</li>
  <li>…</li>
</ul>

<p>One approach is to process files on-the-fly, which is suitable for fast
processing such as image resizing. However, longer running processing it’s
generally better perform eagerly in a background job.</p>

<p>Each approach is suitable for certain requirements, and Shrine is the only
file attachment library that supports both strategies. In this article we’ll
talk about the latter – eager processing.</p>

<h2 id="image-processing">Image processing</h2>

<p>Paperclip, CarrierWave, Dragonfly and Refile all ship with high-level helpers
for image processing via ImageMagick. However, the concept of file processing
isn’t actually specific to the context of accepting file uploads, it is a
generic thing. So wouldn’t it be nice that, instead of each file attachment
library reimplementing file processing over and over again, we just had a
generic library which we could use with <em>any</em> file attachment library?</p>

<p>This is exactly what I did when I created Shrine. I extracted image processing
logic from <a href="https://github.com/refile/refile-mini_magick">Refile::MiniMagick</a>, and released a generic <a href="https://github.com/janko/image_processing">ImageProcessing</a>
library. It provides processing helper methods for <a href="https://www.imagemagick.org">ImageMagick</a>
(using <a href="https://github.com/minimagick/minimagick">MiniMagick</a>) <em>and</em> <a href="http://libvips.github.io/libvips/">libvips</a> (using <a href="https://github.com/libvips/ruby-vips">ruby-vips</a>). Once <a href="https://www.imageflow.io/">ImageFlow</a>
gets released, I will add support for it as well.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"image_processing/mini_magick"</span>

<span class="c1"># convert source.jpg -auto-orient -resize 600x600&gt; -sharpen 0x1 output.jpg</span>
<span class="n">thumbnail</span> <span class="o">=</span> <span class="no">ImageProcessing</span><span class="o">::</span><span class="no">MiniMagick</span>
  <span class="p">.</span><span class="nf">source</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">convert</span><span class="p">(</span><span class="s2">"jpeg"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>

<span class="n">thumbnail</span> <span class="c1">#=&gt; #&lt;Tempfile&gt;</span>
</code></pre></div></div>

<h2 id="eager-processing">Eager processing</h2>

<p>Generating and saving a set of processed files is provided by the
<strong><a href="https://shrinerb.com/docs/plugins/derivatives">derivatives</a></strong> Shrine plugin. We use it by defining a processor that returns
processed files, and then trigger the creation at the desired time:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:derivatives</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">Shrine</span>
  <span class="no">Attacher</span><span class="p">.</span><span class="nf">derivatives</span> <span class="k">do</span> <span class="o">|</span><span class="n">original</span><span class="o">|</span>
    <span class="n">magick</span> <span class="o">=</span> <span class="no">ImageProcessing</span><span class="o">::</span><span class="no">MiniMagick</span><span class="p">.</span><span class="nf">source</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>

    <span class="p">{</span>
      <span class="ss">small:  </span><span class="n">magick</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
      <span class="ss">medium: </span><span class="n">magick</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
      <span class="ss">large:  </span><span class="n">magick</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PhotosController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">photo_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">photo</span><span class="p">.</span><span class="nf">valid?</span>
      <span class="n">photo</span><span class="p">.</span><span class="nf">image_derivatives!</span> <span class="c1"># calls the processor</span>
      <span class="n">photo</span><span class="p">.</span><span class="nf">save</span>
      <span class="c1"># ...</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In contrast to CarrierWave’s implicit class-level DSL or Paperclip’s hash-based
declaration, with Shrine file processing is performed explicitly on the
instance level, using plain Ruby. This gives you full control, allowing things
like extracting processing into a service object and testing it in isolation,
better optimizations, and ability to use any file processing tool you need.</p>

<p>Also, unlike CarrierWave and Paperclip, Shrine actually stores data about
processed files into the database:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span><span class="p">.</span><span class="nf">image_data</span> <span class="c1">#=&gt; </span>
<span class="c1"># {</span>
<span class="c1">#   "id": "fed517.jpg",</span>
<span class="c1">#   "storage": "store",</span>
<span class="c1">#   "metadata": { ... },</span>
<span class="c1">#   "derivatives": {</span>
<span class="c1">#      "small": { "id": "586ef3.jpg", "storage": "store", "metadata": { ... } },</span>
<span class="c1">#      "medium": { "id": "0461d3.jpg", "storage": "store", "metadata": { ... } },</span>
<span class="c1">#      "large": { "id": "4f180c.jpg", "storage": "store", "metadata": { ... } },</span>
<span class="c1">#   }</span>
<span class="c1"># }</span>

<span class="n">photo</span><span class="p">.</span><span class="nf">image_derivatives</span> <span class="c1">#=&gt;</span>
<span class="c1"># {</span>
<span class="c1">#   small: #&lt;Shrine::UploadedFile id="586ef3.jpg" storage=:store ...&gt;,</span>
<span class="c1">#   medium: #&lt;Shrine::UploadedFile id="0461d3.jpg" storage=:store ...&gt;,</span>
<span class="c1">#   large: #&lt;Shrine::UploadedFile id="4f180c.jpg" storage=:store ...&gt;,</span>
<span class="c1"># }</span>
</code></pre></div></div>

<p>You can also trigger processing in a <a href="https://shrinerb.com/docs/plugins/backgrounding">background job</a>:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:backgrounding</span>
<span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">promote_block</span> <span class="p">{</span> <span class="no">PromoteJob</span><span class="p">.</span><span class="nf">perform_later</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">file_data</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PhotosController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">photo_params</span><span class="p">)</span> <span class="c1"># kicks off a background job</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PromoteJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">file_data</span><span class="p">)</span>
    <span class="n">attacher</span> <span class="o">=</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">retrieve</span><span class="p">(</span><span class="ss">model: </span><span class="n">record</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">,</span> <span class="ss">file: </span><span class="n">file_data</span><span class="p">)</span>
    <span class="n">attacher</span><span class="p">.</span><span class="nf">create_derivatives</span> <span class="c1"># call the processor and upload results</span>
    <span class="n">attacher</span><span class="p">.</span><span class="nf">atomic_promote</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Just to show that processing in Shrine isn’t in any way tied to images or the
ImageProcessing gem, here is an example of processing videos using
<a href="https://github.com/streamio/streamio-ffmpeg">streamio-ffmpeg</a>:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"streamio-ffmpeg"</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"streamio-ffmpeg"</span>

<span class="k">class</span> <span class="nc">VideoUploader</span> <span class="o">&lt;</span> <span class="no">Shrine</span>
  <span class="no">Attacher</span><span class="p">.</span><span class="nf">derivatives</span> <span class="k">do</span> <span class="o">|</span><span class="n">original</span><span class="o">|</span>
    <span class="n">transcoded</span> <span class="o">=</span> <span class="no">Tempfile</span><span class="p">.</span><span class="nf">new</span> <span class="p">[</span><span class="s2">"transcoded"</span><span class="p">,</span> <span class="s2">".mp4"</span><span class="p">]</span>
    <span class="n">screenshot</span> <span class="o">=</span> <span class="no">Tempfile</span><span class="p">.</span><span class="nf">new</span> <span class="p">[</span><span class="s2">"screenshot"</span><span class="p">,</span> <span class="s2">".jpg"</span><span class="p">]</span>

    <span class="n">movie</span> <span class="o">=</span> <span class="no">FFMPEG</span><span class="o">::</span><span class="no">Movie</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">original</span><span class="p">.</span><span class="nf">path</span><span class="p">)</span>
    <span class="n">movie</span><span class="p">.</span><span class="nf">transcode</span><span class="p">(</span><span class="n">transcoded</span><span class="p">.</span><span class="nf">path</span><span class="p">)</span>
    <span class="n">movie</span><span class="p">.</span><span class="nf">screenshot</span><span class="p">(</span><span class="n">screenshot</span><span class="p">.</span><span class="nf">path</span><span class="p">)</span>

    <span class="p">{</span> <span class="ss">transcoded: </span><span class="n">transcoded</span><span class="p">,</span> <span class="ss">screenshot: </span><span class="n">screenshot</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="external-processing">External processing</h2>

<p>Shrine’s flexibility allows you to easily delegate processing to other 3rd
party services. As an example, we’ll show transcoding videos with <a href="https://transloadit.com/">Transloadit</a>
using the <a href="https://github.com/shrinerb/shrine-transloadit">shrine-transloadit</a> gem.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"shrine-transloadit"</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Shrine</span><span class="p">.</span><span class="nf">storages</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">cache: </span><span class="no">Shrine</span><span class="o">::</span><span class="no">Storage</span><span class="o">::</span><span class="no">S3</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">prefix: </span><span class="s2">"cache"</span><span class="p">,</span> <span class="o">**</span><span class="n">s3_options</span><span class="p">),</span>
  <span class="ss">store: </span><span class="no">Shrine</span><span class="o">::</span><span class="no">Storage</span><span class="o">::</span><span class="no">S3</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">**</span><span class="n">s3_options</span><span class="p">),</span>
<span class="p">}</span>

<span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:transloadit</span><span class="p">,</span>
  <span class="ss">auth: </span><span class="p">{</span> <span class="ss">key: </span><span class="s2">"&lt;TRANSLOADIT_KEY&gt;"</span><span class="p">,</span> <span class="ss">secret: </span><span class="s2">"&lt;TRANSLOADIT_SECRET&gt;"</span> <span class="p">},</span>
  <span class="ss">credentials: </span><span class="p">{</span> <span class="ss">cache: :s3_store</span><span class="p">,</span> <span class="ss">store: :s3_store</span> <span class="p">}</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">VideoUploader</span> <span class="o">&lt;</span> <span class="no">TransloaditUploader</span>
  <span class="no">Attacher</span><span class="p">.</span><span class="nf">transloadit_processor</span> <span class="k">do</span>
    <span class="n">import</span> <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">transloadit_import_step</span>
    <span class="n">mp4</span>    <span class="o">=</span> <span class="n">transloadit_step</span> <span class="s2">"mp4"</span><span class="p">,</span>  <span class="s2">"/video/encode"</span><span class="p">,</span> <span class="ss">preset: </span><span class="s2">"mp4"</span><span class="p">,</span>  <span class="ss">use: </span><span class="n">import</span>
    <span class="n">webm</span>   <span class="o">=</span> <span class="n">transloadit_step</span> <span class="s2">"webm"</span><span class="p">,</span> <span class="s2">"/video/encode"</span><span class="p">,</span> <span class="ss">preset: </span><span class="s2">"webm"</span><span class="p">,</span> <span class="ss">use: </span><span class="n">import</span>
    <span class="n">ogv</span>    <span class="o">=</span> <span class="n">transloadit_step</span> <span class="s2">"ogv"</span><span class="p">,</span>  <span class="s2">"/video/encode"</span><span class="p">,</span> <span class="ss">preset: </span><span class="s2">"ogv"</span><span class="p">,</span>  <span class="ss">use: </span><span class="n">import</span>
    <span class="n">export</span> <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="nf">transloadit_export_step</span> <span class="ss">use: </span><span class="p">[</span><span class="n">mp4</span><span class="p">,</span> <span class="n">webm</span><span class="p">,</span> <span class="n">ogv</span><span class="p">]</span>

    <span class="n">assembly</span> <span class="o">=</span> <span class="n">transloadit</span><span class="p">.</span><span class="nf">assembly</span><span class="p">(</span><span class="ss">steps: </span><span class="p">[</span><span class="n">import</span><span class="p">,</span> <span class="n">mp4</span><span class="p">,</span> <span class="n">webm</span><span class="p">,</span> <span class="n">ogv</span><span class="p">,</span> <span class="n">export</span><span class="p">])</span>
    <span class="n">assembly</span><span class="p">.</span><span class="nf">create!</span>
  <span class="k">end</span>

  <span class="no">Attacher</span><span class="p">.</span><span class="nf">transloadit_saver</span> <span class="k">do</span> <span class="o">|</span><span class="n">results</span><span class="o">|</span>
    <span class="n">mp4</span>  <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="nf">transloadit_file</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">"mp4"</span><span class="p">])</span>
    <span class="n">webm</span> <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="nf">transloadit_file</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">"webm"</span><span class="p">])</span>
    <span class="n">ogv</span>  <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="nf">transloadit_file</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">"ogv"</span><span class="p">])</span>

    <span class="n">merge_derivatives</span><span class="p">(</span><span class="ss">mp4: </span><span class="n">mp4</span><span class="p">,</span> <span class="ss">webm: </span><span class="n">webm</span><span class="p">,</span> <span class="ss">ogv: </span><span class="n">ogv</span><span class="p">)</span> <span class="c1"># save processed results</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">VideoController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">video</span> <span class="o">=</span> <span class="no">Video</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">video_params</span><span class="p">)</span>

    <span class="no">TranscodeJob</span><span class="p">.</span><span class="nf">perform_later</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="ss">:file</span><span class="p">,</span> <span class="n">video</span><span class="p">.</span><span class="nf">file_data</span><span class="p">)</span>

    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TranscodeJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">file_data</span><span class="p">)</span>
    <span class="n">attacher</span> <span class="o">=</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">retrieve</span><span class="p">(</span><span class="ss">model: </span><span class="n">video</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">,</span> <span class="ss">file: </span><span class="n">file_data</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">attacher</span><span class="p">.</span><span class="nf">transloadit_process</span> <span class="c1"># calls processor</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">reload_until_finished!</span>

    <span class="n">attacher</span><span class="p">.</span><span class="nf">transloadit_save</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">"results"</span><span class="p">])</span> <span class="c1"># calls saver</span>
    <span class="n">attacher</span><span class="p">.</span><span class="nf">atomic_persist</span>
  <span class="k">rescue</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">AttachmentChanged</span><span class="p">,</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span>
    <span class="n">attacher</span><span class="p">.</span><span class="nf">destroy</span> <span class="c1"># destroy orphaned files</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The above will spawn a <code class="language-plaintext highlighter-rouge">TranscodeJob</code> when a video is attached, then in the
background job it will call Transloadit, wait for processing to finish, then
save the results. If in the meantime the attachment has changed or the record
was deleted, we make sure to delete the processed files to not leave any orphan
files in our storage.</p>

<p>Notice how the <code class="language-plaintext highlighter-rouge">derivatives</code> plugin allowed us to easily save files uploaded by
Transloadit with <code class="language-plaintext highlighter-rouge">Attacher#merge_derivatives</code>. This way processed files are
retrieved the same as if we did the processing ourselves, which enables our
application to remain agnostic as to how the files were processed.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">video</span><span class="p">.</span><span class="nf">file_derivatives</span> <span class="c1">#=&gt; </span>
<span class="c1"># {</span>
<span class="c1">#   mp4:  #&lt;Shrine::UploadedFile id="c8ed02.mp4" storage=:store ...&gt;,</span>
<span class="c1">#   webm: #&lt;Shrine::UploadedFile id="f426d8.webm" storage=:store ...&gt;,</span>
<span class="c1">#   ogv:  #&lt;Shrine::UploadedFile id="7a79d6.ogv" storage=:store ...&gt;,</span>
<span class="c1"># }</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>Since my goal with Shrine was to create a file attachment library that works
for everyone, I wanted to make sure that there aren’t any limits in ways that
you can do file processing. We’ve seen how we can do processing ourselves, or
easily delegate it to a 3rd party service. This makes Shrine a versatile tool
for handling any type of file uploads.</p>


  </div>
</article>

<div class="mt-8 md:mt-10">
  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'twinblog'; // required: replace example with your forum shortname
    var disqus_identifier = '/better-file-uploads-with-shrine-processing';
    var disqus_url = 'https://janko.io/better-file-uploads-with-shrine-processing/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</div>

      </main>
    </div>

    <div class="border-t py-7 mt-10 bg-gray-50">
      <footer class="max-w-screen-sm md:max-w-screen-md mx-auto flex flex-col space-y-2 md:flex-row md:justify-between md:space-y-0 text-base">
        <ul class="inline-flex space-x-3 font-medium justify-center md:justify-left">
          <li><a href="/">Articles</a></li>
          <li><a href="/about">About</a></li>
          <li><a href="https://github.com/janko/janko.io">Source code</a></li>
        </ul>
        <p class="text-gray-400 text-center md:text-left">
          © 2023 Janko Marohnić. All rights reserved.
        </p>
      </footer>
    </div>

    
      <!-- Fathom - beautiful, simple website analytics -->
<script src="https://bouncy-van.janko.io/script.js" data-site="EKJCVCTX" defer></script>
<!-- / Fathom -->

    
  </body>
</html>
