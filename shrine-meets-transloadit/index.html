<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Shrine meets Transloadit | Janko's Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Shrine meets Transloadit" />
<meta name="author" content="Janko Marohnić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="When I’m building web applications, a requirement that almost always comes up is that the app needs to accept file uploads. It can be an app with users that have profile images, posts that have cover photos and some additional documents attached, or whole galleries where people can upload many photos or videos." />
<meta property="og:description" content="When I’m building web applications, a requirement that almost always comes up is that the app needs to accept file uploads. It can be an app with users that have profile images, posts that have cover photos and some additional documents attached, or whole galleries where people can upload many photos or videos." />
<link rel="canonical" href="https://janko.io/shrine-meets-transloadit/" />
<meta property="og:url" content="https://janko.io/shrine-meets-transloadit/" />
<meta property="og:site_name" content="Janko’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-07-11T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Shrine meets Transloadit" />
<meta name="twitter:site" content="@jankomarohnic" />
<meta name="twitter:creator" content="@jankomarohnic" />
<meta property="article:publisher" content="https://www.facebook.com/janko.marohnic/" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://janko.io/images/logo.png"},"name":"Janko Marohnić"},"url":"https://janko.io/shrine-meets-transloadit/","headline":"Shrine meets Transloadit","dateModified":"2016-07-11T00:00:00+02:00","datePublished":"2016-07-11T00:00:00+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://janko.io/shrine-meets-transloadit/"},"author":{"@type":"Person","name":"Janko Marohnić"},"description":"When I’m building web applications, a requirement that almost always comes up is that the app needs to accept file uploads. It can be an app with users that have profile images, posts that have cover photos and some additional documents attached, or whole galleries where people can upload many photos or videos.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="https://janko.io/feed.xml" title="Janko&apos;s Blog" />
    <link rel="stylesheet" href="/css/bundle.css">
  </head>

  <body class="text-xl text-gray-700">
    <header class="py-3 px-4 flex flex-col space-y-1 bg-gray-100 border-b">
      <div class="flex justify-center">
        <a class="flex items-center space-x-2" href="/">
          <img class="h-8" src="/images/logo.png" alt="logo" />
          <span class="text-2xl md:text-3xl font-semibold text-pink-700">Janko's Blog</span>
        </a>
      </div>
      <div class="flex justify-center">
        <span class="text-base md:text-lg text-gray-500">Sharing the wonders of Ruby</p>
      </div>
    </header>

    <div class="my-6 sm:my-8 mx-4">
      <main class="max-w-screen-sm md:max-w-screen-md mx-auto">
        <article>
  <header class="space-y-4 md:space-y-5">
    <h1 class="lg:-mx-28 text-3xl sm:text-4xl lg:text-5xl text-center font-medium text-gray-900">Shrine meets Transloadit</h1>

    <div class="flex justify-center">
      <div class="flex flex-col items-center sm:flex-row sm:items-baseline space-y-3 sm:space-y-0 sm:space-x-4 text-sm md:text-base">
        <span class="text-gray-500">
          By <a class="underline hover:text-gray-700" href="/about">Janko Marohnić</a> on
          <time datetime="2016-07-11 00:00:00 +0200">
            11 Jul 2016
          </time>
        </span>
        
          
<a class="my-1 rounded-full px-3 bg-red-100 text-red-700 font-semibold py-0.5" href="/shrine">shrine</a>


        
      </div>
    </div>
  </header>

  <div class="mt-4 sm:mt-6 markdown">
    <p>When I’m building web applications, a requirement that almost always comes up
is that the app needs to accept file uploads. It can be an app with users that
have profile images, posts that have cover photos and some additional documents
attached, or whole galleries where people can upload many photos or videos.</p>

<p>Because I wasn’t satisfied with current Ruby libraries for handling file
attachments, I created <a href="https://shrinerb.com">Shrine</a>. Its goal was to give you complete control
over the whole attachment process, while still keeping convenience. It comes
with many advanced features out-of-the-box, most notable being the ability to
build a <a href="/file-uploads-asynchronous-world/">fully asynchronous user experience</a> using direct uploads and
background jobs.</p>

<p>In order to best display uploaded files to the users, we usually want to apply
some kind of processing beforehand. We might want to generate multiple sizes of
an uploaded image, split PDF pages into individual images, or encode videos and
extract thumbnails from them. Like other file upload libraries, Shrine allows
us to perform our own processing.</p>

<p>However, doing your own processing comes at a cost of having to scale it, so it
often makes sense to delegate processing to a dedicate service, which gives you
more time to focus on the business logic of your application. One service for
file processing that really impressed me is <strong>Transloadit</strong>.</p>

<h2 id="transloadit">Transloadit</h2>

<p><a href="https://transloadit.com/">Transloadit</a> is a service for uploading and processing any kind of media,
including images, videos, audio, and documents, along with importing from and
exporting to various storage services. It is extremely versatile, and by doing
processing asynchronously it’s suitable for both quick processing and long
running jobs. Transloadit is also the company behind <a href="http://tus.io/">tus</a>, an open protocol
for resumable file uploads.</p>

<p>Unlike most other file processing services, Transloadit is only in charge of
processing, and allows you to export the processed files to dedicated storage
services like Amazon S3. This means that Transloadit will work as an <em>addition</em>
to your primary storage, not a replacement. It also means that our file
attachments library needs to be flexible enough to support implementing this
kind of flow.</p>

<p>Luckily, Shrine’s <a href="https://shrinerb.com/docs/creating-storages">plugin system</a> allows us to easily extend any part of
Shrine, enabling us to add Transloadit-specific methods and intercept default
actions. Using this and Transloadit’s <a href="https://github.com/transloadit/ruby-sdk">Ruby SDK</a>, I created
<strong><a href="https://github.com/shrinerb/shrine-transloadit">shrine-transloadit</a></strong>.</p>

<h2 id="integration">Integration</h2>

<p>Let’s assume that we have an application which already accepts photo uploads to
Amazon S3 using Shrine, and we want to add processing with Transloadit. First,
we need to create our S3 credentails in Transloadit, let’s say we named them
<code class="language-plaintext highlighter-rouge">s3_store</code>.</p>

<p>Now we can configure Shrine and shrine-transloadit with our credentials:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s2">"shrine"</span><span class="p">,</span> <span class="s2">"~&gt; 3.0"</span>
<span class="n">gem</span> <span class="s2">"aws-sdk-s3"</span><span class="p">,</span> <span class="s2">"~&gt; 1.14"</span> <span class="c1"># for Amazon S3</span>
<span class="n">gem</span> <span class="s2">"shrine-transloadit"</span><span class="p">,</span> <span class="s2">"~&gt; 1.0"</span>
</code></pre></div></div>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"shrine"</span>
<span class="nb">require</span> <span class="s2">"shrine/storage/s3"</span>

<span class="n">s3_options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">access_key_id:     </span><span class="s2">"&lt;YOUR_ACCESS_KEY_ID&gt;"</span><span class="p">,</span>
  <span class="ss">secret_access_key: </span><span class="s2">"&lt;YOUR_SECRET_ACCESS_KEY&gt;"</span><span class="p">,</span>
  <span class="ss">region:            </span><span class="s2">"&lt;YOUR_REGION&gt;"</span><span class="p">,</span>
  <span class="ss">bucket:            </span><span class="s2">"&lt;YOUR_BUCKET&gt;"</span><span class="p">,</span>
<span class="p">}</span>

<span class="no">Shrine</span><span class="p">.</span><span class="nf">storages</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">cache: </span><span class="no">Shrine</span><span class="o">::</span><span class="no">Storage</span><span class="o">::</span><span class="no">S3</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">prefix: </span><span class="s2">"cache"</span><span class="p">,</span> <span class="o">**</span><span class="n">s3_options</span><span class="p">),</span>
  <span class="ss">store: </span><span class="no">Shrine</span><span class="o">::</span><span class="no">Storage</span><span class="o">::</span><span class="no">S3</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">**</span><span class="n">s3_options</span><span class="p">),</span>
<span class="p">}</span>

<span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:transloadit</span><span class="p">,</span>
  <span class="ss">auth: </span><span class="p">{</span>
    <span class="ss">key:    </span><span class="s2">"&lt;YOUR_TRANSLOADIT_KEY&gt;"</span><span class="p">,</span>
    <span class="ss">secret: </span><span class="s2">"&lt;YOUR_TRANSLOADIT_SECRET&gt;"</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="ss">credentials: </span><span class="p">{</span>
    <span class="ss">cache: :s3_store</span><span class="p">,</span> <span class="c1"># use "s3_store" for :cache storage credentials</span>
    <span class="ss">store: :s3_store</span><span class="p">,</span> <span class="c1"># use "s3_store" for :store storage credentials</span>
  <span class="p">}</span>

<span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:derivatives</span> <span class="c1"># for storing processed results</span>
</code></pre></div></div>

<p>Next, we can define a “processor” that will create a Transloadit assembly, and
a “saver” that will save the processed results:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">Shrine</span>
  <span class="no">Attacher</span><span class="p">.</span><span class="nf">transloadit_processor</span> <span class="k">do</span>
    <span class="n">import</span>   <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">transloadit_import_step</span>
    <span class="n">optimize</span> <span class="o">=</span> <span class="n">transloadit_step</span> <span class="s2">"optimize"</span><span class="p">,</span> <span class="s2">"/image/optimize"</span><span class="p">,</span> <span class="ss">use: </span><span class="n">import</span>
    <span class="n">resize</span>   <span class="o">=</span> <span class="n">transloadit_step</span> <span class="s2">"resize"</span><span class="p">,</span>   <span class="s2">"/image/resize"</span><span class="p">,</span>   <span class="ss">use: </span><span class="n">import</span><span class="p">,</span> <span class="ss">width: </span><span class="mi">300</span>
    <span class="n">export</span>   <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="nf">transloadit_export_step</span> <span class="ss">use: </span><span class="p">[</span><span class="n">import</span><span class="p">,</span> <span class="n">optimize</span><span class="p">,</span> <span class="n">resize</span><span class="p">]</span>

    <span class="n">assembly</span> <span class="o">=</span> <span class="n">transloadit</span><span class="p">.</span><span class="nf">assembly</span><span class="p">(</span><span class="ss">steps: </span><span class="p">[</span><span class="n">import</span><span class="p">,</span> <span class="n">optimize</span><span class="p">,</span> <span class="n">resize</span><span class="p">,</span> <span class="n">export</span><span class="p">])</span>
    <span class="n">assembly</span><span class="p">.</span><span class="nf">create!</span>
  <span class="k">end</span>

  <span class="no">Attacher</span><span class="p">.</span><span class="nf">transloadit_processor</span> <span class="k">do</span> <span class="o">|</span><span class="n">results</span><span class="o">|</span>
    <span class="n">optimized</span> <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="nf">transloadit_file</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">"optimize"</span><span class="p">])</span>
    <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="nf">transloadit_file</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">"resize"</span><span class="p">])</span>

    <span class="n">merge_derivatives</span><span class="p">(</span><span class="ss">optimized: </span><span class="n">optimized</span><span class="p">,</span> <span class="ss">thumbnail: </span><span class="n">thumbnail</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now we’re ready to perform the processing with Transloadit:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PhotosController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">photo_params</span><span class="p">)</span>

    <span class="no">ProcessImageJob</span><span class="p">.</span><span class="nf">perform_later</span><span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="ss">:image</span><span class="p">)</span>

    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ProcessImageJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span>
    <span class="n">attacher</span> <span class="o">=</span> <span class="n">record</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="ss">_attacher"</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">attacher</span><span class="p">.</span><span class="nf">transloadit_process</span> <span class="c1"># calls processor</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">reload_until_finished!</span>

    <span class="n">attacher</span><span class="p">.</span><span class="nf">transloadit_save</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">"results"</span><span class="p">])</span> <span class="c1"># calls saver</span>
    <span class="n">attacher</span><span class="p">.</span><span class="nf">persist</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And that’s it! Now when we upload an image to S3 and save the database record,
a background job will be spawned which will trigger Transloadit processing.
When Transloadit is finished, the processing results will be saved into the
database record.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span><span class="p">.</span><span class="nf">image_derivatives</span> <span class="c1">#=&gt;</span>
<span class="c1"># {</span>
<span class="c1">#   optimized: #&lt;Shrine::UploadedFile ...&gt;,</span>
<span class="c1">#   thumbnail: #&lt;Shrine::UploadedFile ...&gt;,</span>
<span class="c1"># }</span>
</code></pre></div></div>

<p>If you want to see how it all fits together, I created a <a href="https://github.com/shrinerb/shrine-transloadit/tree/master/demo">demo app</a> using
shrine-transloadit, which is a good starting point for anyone wanting to add
Transloadit to their Ruby applications. For any additional information head out
to the <strong><a href="https://github.com/shrinerb/shrine-transloadit">shrine-transloadit</a></strong> GitHub respository.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Thanks to shrine-transloadit, we were able to easily delegate processing to an
external service, and have the processed results saved to the database record.
Transloadit has a rich arsenal of “<a href="https://transloadit.com/docs/conversion-robots/">robots</a>”, so we still have incredible
flexibility in how we want to do our processing, but without the hassle of
having to scale it.</p>


  </div>
</article>

<div class="mt-8 md:mt-10">
  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'twinblog'; // required: replace example with your forum shortname
    var disqus_identifier = '/shrine-meets-transloadit';
    var disqus_url = 'https://janko.io/shrine-meets-transloadit/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</div>

      </main>
    </div>

    
      <script>
  // Gauges
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '51f5bd47f5a1f545ac0000fc');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>

    
  </body>
</html>
