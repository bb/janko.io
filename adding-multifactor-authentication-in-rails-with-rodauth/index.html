<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Multifactor Authentication in Rails with Rodauth | Janko's Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Multifactor Authentication in Rails with Rodauth" />
<meta name="author" content="Janko Marohniƒá" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Multi-factor authentication or MFA (generalized two-factor authentication or 2FA) is a method of authentication where the user is required to provide two or more pieces of evidence (‚Äúfactors‚Äù) in order to be granted access. Typically the user would first prove knowledge of something only they know (e.g. their password), and then prove posession of something only they own (e.g. another device). This provides an extra layer of security for the user‚Äôs account." />
<meta property="og:description" content="Multi-factor authentication or MFA (generalized two-factor authentication or 2FA) is a method of authentication where the user is required to provide two or more pieces of evidence (‚Äúfactors‚Äù) in order to be granted access. Typically the user would first prove knowledge of something only they know (e.g. their password), and then prove posession of something only they own (e.g. another device). This provides an extra layer of security for the user‚Äôs account." />
<link rel="canonical" href="https://janko.io/adding-multifactor-authentication-in-rails-with-rodauth/" />
<meta property="og:url" content="https://janko.io/adding-multifactor-authentication-in-rails-with-rodauth/" />
<meta property="og:site_name" content="Janko‚Äôs Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-21T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Multifactor Authentication in Rails with Rodauth" />
<meta name="twitter:site" content="@jankomarohnic" />
<meta name="twitter:creator" content="@jankomarohnic" />
<meta property="article:publisher" content="https://www.facebook.com/janko.marohnic/" />
<script type="application/ld+json">
{"@type":"BlogPosting","description":"Multi-factor authentication or MFA (generalized two-factor authentication or 2FA) is a method of authentication where the user is required to provide two or more pieces of evidence (‚Äúfactors‚Äù) in order to be granted access. Typically the user would first prove knowledge of something only they know (e.g. their password), and then prove posession of something only they own (e.g. another device). This provides an extra layer of security for the user‚Äôs account.","headline":"Multifactor Authentication in Rails with Rodauth","dateModified":"2020-12-21T00:00:00+01:00","datePublished":"2020-12-21T00:00:00+01:00","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://janko.io/images/logo.png"},"name":"Janko Marohniƒá"},"url":"https://janko.io/adding-multifactor-authentication-in-rails-with-rodauth/","mainEntityOfPage":{"@type":"WebPage","@id":"https://janko.io/adding-multifactor-authentication-in-rails-with-rodauth/"},"author":{"@type":"Person","name":"Janko Marohniƒá"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="https://janko.io/feed.xml" title="Janko&apos;s Blog" />
    <link rel="stylesheet" href="/css/bundle.css">
  </head>

  <body class="text-xl text-gray-700">
    <header class="py-3 px-4 flex flex-col space-y-1 bg-gray-100 border-b">
      <div class="flex justify-center">
        <a class="flex items-center space-x-2" href="/">
          <img class="h-8" src="/images/logo.png" alt="logo" />
          <span class="text-2xl md:text-3xl font-semibold text-pink-700">Janko's Blog</span>
        </a>
      </div>
      <div class="flex justify-center">
        <span class="text-base md:text-lg text-gray-500">Sharing the wonders of Ruby</p>
      </div>
    </header>

    <div class="text-center py-3 px-4 bg-sky-50 border-b border-sky-100 text-sky-600 text-base md:text-md lg:text-lg">
      Dear Russian friends, please watch President Zelenskyy's <a href="https://www.youtube.com/watch?v=p-zilnPtZ2M" class="underline text-blue-600 hover:text-blue-500">speech addressed to you</a>.
      üá∫üá¶ Support Ukraine by <a href="https://war.ukraine.ua/support-ukraine/" class="underline text-yellow-600 hover:text-yellow-500">donating</a> to humanitarian aid.
    </div>

    <div class="my-6 sm:my-8 mx-4">
      <main class="max-w-screen-sm md:max-w-screen-md mx-auto">
        <article>
  <header class="space-y-4 md:space-y-5">
    <h1 class="lg:-mx-28 text-3xl sm:text-4xl lg:text-5xl text-center font-medium text-gray-900">Multifactor Authentication in Rails with Rodauth</h1>

    <div class="flex justify-center">
      <div class="flex flex-col items-center sm:flex-row sm:items-baseline space-y-3 sm:space-y-0 sm:space-x-4 text-sm md:text-base">
        <span class="text-gray-500">
          By <a class="underline hover:text-gray-700" href="/about">Janko Marohniƒá</a> on
          <time datetime="2020-12-21 00:00:00 +0100">
            21 Dec 2020
          </time>
        </span>
        
          
<a class="my-1 rounded-full px-3 bg-blue-100 text-blue-700 font-semibold py-0.5" href="/rodauth">rodauth</a>


        
      </div>
    </div>
  </header>

  <div class="mt-4 sm:mt-6 markdown">
    <p>Multi-factor authentication or MFA (generalized two-factor authentication or
2FA) is a method of authentication where the user is required to provide two or
more pieces of evidence (‚Äúfactors‚Äù) in order to be granted access. Typically
the user would first prove knowledge of something only they <em>know</em> (e.g. their
password), and then prove posession of something only they <em>own</em> (e.g. another
device). This provides an extra layer of security for the user‚Äôs account.</p>

<p>Most common multifactor authentication methods include:</p>

<ul>
  <li>
    <p><strong>TOTP</strong> (Time-based One-Time Passwords) ‚Äì user has an app installed on
their device that displays the authentication code, which is refreshed every
30 seconds</p>
  </li>
  <li>
    <p><strong>SMS codes</strong> ‚Äì user receives authentication codes on their phone via SMS
when the application requests them</p>
  </li>
  <li>
    <p><strong>Recovery codes</strong> ‚Äì user is given a fixed set of one-time codes they can
enter when logging in (this is typically used as a backup method)</p>
  </li>
  <li>
    <p><strong><a href="https://webauthn.io/">WebAuthn</a></strong> ‚Äì user authenticates themselves using a <a href="https://en.wikipedia.org/wiki/Universal_2nd_Factor">security key</a> or
built-in platform biometric sensors (e.g. fingerprint)</p>
  </li>
</ul>

<p>In this article, I want to show you how to add multifactor authentication to
a Rails app using <a href="https://github.com/jeremyevans/rodauth/">Rodauth</a>, which has built-in support for each of the
multifactor authentication methods mentioned above. Compared to alternatives<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>,
Rodauth provides a much more integrated experience by shipping with complete
endpoints, default HTML templates, session management, lockout logic and
more<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>. To keep the tutorial focused, we‚Äôll be implementing just the first
three methods, as they‚Äôre by far the most common.</p>

<p>We‚Äôll be using the <a href="https://github.com/janko/rodauth-rails">rodauth-rails</a> gem, and we‚Äôll be continuing off of the
application we started building in <a href="/adding-authentication-in-rails-with-rodauth/">my previous article</a>. The
goal functionality: allow users to set up TOTP as their primary MFA method, and
use SMS codes and recovery codes as backup MFA methods.</p>

<h2 id="totp">TOTP</h2>

<p>The TOTP functionality is provided by Rodauth‚Äôs <a href="http://rodauth.jeremyevans.net/rdoc/files/doc/otp_rdoc.html"><code class="language-plaintext highlighter-rouge">otp</code></a> feature. It
depends on the <a href="https://github.com/mdp/rotp">rotp</a> and <a href="https://github.com/whomwah/rqrcode">rqrcode</a> gems, so let‚Äôs first install those:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle add rotp rqrcode
</code></pre></div></div>

<p>Next, we need to create the required database table. For this we‚Äôll use the
migration generator provided by rodauth-rails:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rails generate rodauth:migration otp
<span class="c"># create  db/migrate/20201214200106_create_rodauth_otp.rb</span>

<span class="nv">$ </span>rails db:migrate
<span class="c"># == 20201214200106 CreateRodauthOtp: migrating =======================</span>
<span class="c"># -- create_table(:account_otp_keys)</span>
<span class="c"># == 20201214200106 CreateRodauthOtp: migrated ========================</span>
</code></pre></div></div>

<p>Now we can enable the <code class="language-plaintext highlighter-rouge">otp</code> feature in our Rodauth configuration:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/misc/rodauth_main.rb</span>
<span class="k">class</span> <span class="nc">RodauthMain</span> <span class="o">&lt;</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Auth</span>
  <span class="n">configure</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">enable</span> <span class="ss">:otp</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This adds the following routes to our application:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/otp-auth</code> ‚Äì authenticate via TOTP code</li>
  <li><code class="language-plaintext highlighter-rouge">/otp-setup</code> ‚Äì set up TOTP authentication</li>
  <li><code class="language-plaintext highlighter-rouge">/otp-disable</code> ‚Äì disable TOTP authentication</li>
  <li><code class="language-plaintext highlighter-rouge">/multifactor-manage</code> ‚Äì set up or disable available MFA methods</li>
  <li><code class="language-plaintext highlighter-rouge">/multifactor-auth</code> ‚Äì authenticate via available MFA methods</li>
  <li><code class="language-plaintext highlighter-rouge">/multifactor-disable</code> ‚Äì disable all MFA methods</li>
</ul>

<p>To allow the user to configure MFA, let‚Äôs display a link to the
<code class="language-plaintext highlighter-rouge">/multifactor-manage</code> route for managing MFA methods in our views:</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- app/views/application/_navbar.html.erb --&gt;</span>
<span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">logged_in?</span> <span class="cp">%&gt;</span>
  <span class="c">&lt;!-- ... ---&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Manage MFA"</span><span class="p">,</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">two_factor_manage_path</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"dropdown-item"</span> <span class="cp">%&gt;</span>
  <span class="c">&lt;!-- ... ---&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>Now when the user logs in and clicks on ‚ÄúManage MFA‚Äù, they‚Äôll get redirected to
the OTP setup page that Rodauth provides out-of-the-box<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>:</p>

<p><img src="/images/rodauth-otp-setup.png" alt="Rodauth OTP setup page" /></p>

<p>The user can now scan the QR code using an authenticator app such as Google
Authenticator, Microsoft Authenticator or Authy, and enter the OTP code (along
with their current password) to finish setting up OTP. As a developer, you can
generate the code from the OTP secret using the ROTP gem:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rotp <span class="nt">--secret</span> omo2p3movepqyc222rp54v3cic7ky2au
409761
</code></pre></div></div>

<p>When the user with OTP set up logs in the next time, we want them to be
automatically redirected to the OTP auth page. We can achieve this by requiring
logged in users that have MFA set up to authenticate with 2nd factor, and
tweaking the flash messages to make it feel like part of one signin:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/misc/rodauth_app.rb</span>
<span class="k">class</span> <span class="nc">RodauthApp</span> <span class="o">&lt;</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">App</span>
  <span class="c1"># ...</span>
  <span class="n">route</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
    <span class="c1"># ...</span>
    <span class="c1"># require MFA if the user is logged in and has MFA setup</span>
    <span class="k">if</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">uses_two_factor_authentication?</span>
      <span class="n">rodauth</span><span class="p">.</span><span class="nf">require_two_factor_authenticated</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/misc/rodauth_main.rb</span>
<span class="k">class</span> <span class="nc">RodauthMain</span> <span class="o">&lt;</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Auth</span>
  <span class="n">configure</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="c1"># don't show error message when redirected after login</span>
    <span class="n">two_factor_need_authentication_error_flash</span> <span class="p">{</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">==</span> <span class="n">login_notice_flash</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="k">super</span><span class="p">()</span> <span class="p">}</span>
    <span class="c1"># show generic authentication message</span>
    <span class="n">two_factor_auth_notice_flash</span> <span class="p">{</span> <span class="n">login_notice_flash</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><img src="/images/rodauth-otp-auth.png" alt="Rodauth TOTP authentication page" /></p>

<h2 id="recovery-codes">Recovery codes</h2>

<p>After the user sets up TOTP, it‚Äôs recommended to also generate a set of
‚Äúrecovery‚Äù codes for them to save somewhere, which they can use on login in
case they lose access to their TOTP device. This functionality is provided by
Rodauth‚Äôs <a href="http://rodauth.jeremyevans.net/rdoc/files/doc/recovery_codes_rdoc.html"><code class="language-plaintext highlighter-rouge">recovery_codes</code></a> feature.</p>

<p>Let‚Äôs start by creating the required database table:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rails generate rodauth:migration recovery_codes
<span class="c"># create  db/migrate/20201214200106_create_rodauth_recovery_codes.rb</span>

<span class="nv">$ </span>rails db:migrate
<span class="c"># == 20201217071036 CreateRodauthRecoveryCodes: migrating =======================</span>
<span class="c"># -- create_table(:account_recovery_codes, {:primary_key=&gt;[:id, :code]})</span>
<span class="c"># == 20201217071036 CreateRodauthRecoveryCodes: migrated ========================</span>
</code></pre></div></div>

<p>And enabling the <code class="language-plaintext highlighter-rouge">recovery_codes</code> feature in our Rodauth configuration:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/misc/rodauth_main.rb</span>
<span class="k">class</span> <span class="nc">RodauthMain</span> <span class="o">&lt;</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Auth</span>
  <span class="n">configure</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">enable</span> <span class="ss">:otp</span><span class="p">,</span> <span class="ss">:recovery_codes</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This adds the following routes to our app:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/recovery-auth</code> ‚Äì authenticate via a recovery code</li>
  <li><code class="language-plaintext highlighter-rouge">/recovery-codes</code> ‚Äì view &amp; add recovery codes</li>
</ul>

<p>We‚Äôll now override the <code class="language-plaintext highlighter-rouge">after_otp_setup</code> hook to display recovery codes to the
user after they‚Äôve successfully set up TOTP, instead of the default redirect.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/misc/rodauth_main.rb</span>
<span class="k">class</span> <span class="nc">RodauthMain</span> <span class="o">&lt;</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Auth</span>
  <span class="n">configure</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="c1"># automatically generate recovery codes after enabling first MFA method</span>
    <span class="n">auto_add_recovery_codes?</span> <span class="kp">true</span>
    <span class="c1"># automatically remove recovery codes after disabling last MFA method</span>
    <span class="n">auto_remove_recovery_codes?</span> <span class="kp">true</span>
    <span class="c1"># display recovery codes after TOTP setup</span>
    <span class="n">after_otp_setup</span> <span class="k">do</span>
      <span class="n">set_notice_now_flash</span> <span class="s2">"</span><span class="si">#{</span><span class="n">otp_setup_notice_flash</span><span class="si">}</span><span class="s2">, please make note of your recovery codes"</span>
      <span class="n">return_response</span> <span class="n">add_recovery_codes_view</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We‚Äôll also override the default Rodauth template to display the recovery codes
in a nicer way. For convenience, we‚Äôll add a download link for the recovery
codes as well. Instead of adding a new endpoint, which would have to be
password-protected to maintain security, we‚Äôll just implement the download link
in plain HTML using a data URL and <code class="language-plaintext highlighter-rouge">download</code> attribute.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rails generate rodauth:views recovery_codes
</code></pre></div></div>
<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- app/views/rodauth/add_recovery_codes.html.erb --&gt;</span>
<span class="cp">&lt;%</span> <span class="n">content_for</span> <span class="ss">:title</span><span class="p">,</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">add_recovery_codes_page_title</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">recovery_codes</span><span class="p">.</span><span class="nf">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"my-3"</span><span class="nt">&gt;</span>
    Copy these recovery codes to a safe location.
    You can also download them <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"here"</span><span class="p">,</span> <span class="s2">"data:,</span><span class="si">#{</span><span class="n">rodauth</span><span class="p">.</span><span class="nf">recovery_codes</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">download: </span><span class="s2">"myapp-recovery-codes.txt"</span> <span class="cp">%&gt;</span>.
  <span class="nt">&lt;/p&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"d-inline-block mb-3 border border-info rounded px-3 py-2"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">recovery_codes</span><span class="p">.</span><span class="nf">each_slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">code1</span><span class="p">,</span> <span class="n">code2</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row text-info text-left"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-lg my-1 font-monospace"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">code1</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-lg my-1 font-monospace"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">code2</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="c">&lt;!-- Used for filling in missing recovery codes later on --&gt;</span>
<span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">can_add_recovery_codes?</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span><span class="o">=</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">add_recovery_codes_heading</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">template: </span><span class="s2">"rodauth/recovery_codes"</span><span class="p">,</span> <span class="ss">layout: </span><span class="kp">false</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>When the user now sets up TOTP, they will be shown a page like this:</p>

<p><img src="/images/rodauth-recovery-view.png" alt="Rodauth page for viewing and downloading recovery codes" /></p>

<p>And when they log into their account the next time, on the multifactor auth
page they can choose to enter a recovery code instead of TOTP.</p>

<p><img src="/images/rodauth-recovery-auth.png" alt="Multifactor auth page with OTP and recovery codes options" /></p>

<h2 id="sms-codes">SMS codes</h2>

<p>In addition to TOTP, it‚Äôs good practice to also provide the ability to use SMS
codes for 2nd factor authentication. Rodauth provides a specialized
<a href="http://rodauth.jeremyevans.net/rdoc/files/doc/sms_codes_rdoc.html"><code class="language-plaintext highlighter-rouge">sms_codes</code></a> feature for this.</p>

<p>To set it up, we again create the required database table:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rails generate rodauth:migration sms_codes
<span class="c"># create  db/migrate/20201219173710_create_rodauth_sms_codes.rb</span>

<span class="nv">$ </span>rails db:migrate
<span class="c"># == 20201219173710 CreateRodauthSmsCodes: migrating ==================</span>
<span class="c"># -- create_table(:account_sms_codes)</span>
<span class="c"># == 20201219173710 CreateRodauthSmsCodes: migrated ===================</span>
</code></pre></div></div>

<p>And enable the <code class="language-plaintext highlighter-rouge">sms_codes</code> feature in the Rodauth configuration:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/misc/rodauth_main.rb</span>
<span class="k">class</span> <span class="nc">RodauthMain</span> <span class="o">&lt;</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Auth</span>
  <span class="n">configure</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">enable</span> <span class="ss">:otp</span><span class="p">,</span> <span class="ss">:recovery_codes</span><span class="p">,</span> <span class="ss">:sms_codes</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This adds the following routes to our app:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/sms-request</code> ‚Äì request the SMS code to be sent</li>
  <li><code class="language-plaintext highlighter-rouge">/sms-auth</code> ‚Äì authenticate via an SMS code</li>
  <li><code class="language-plaintext highlighter-rouge">/sms-setup</code> ‚Äì set up SMS codes authentication</li>
  <li><code class="language-plaintext highlighter-rouge">/sms-confirm</code> ‚Äì confirm the provided phone number</li>
  <li><code class="language-plaintext highlighter-rouge">/sms-disable</code> ‚Äì disable SMS codes authentication</li>
</ul>

<p>When an SMS code is requested, Rodauth calls the <code class="language-plaintext highlighter-rouge">sms_send</code> method with the
configured phone number and a corresponding text message. This method isn‚Äôt
defined by default, since Rodauth doesn‚Äôt know how we want to send the SMS,
instead we‚Äôre expected to implement <code class="language-plaintext highlighter-rouge">sms_send</code>:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/misc/rodauth_main.rb</span>
<span class="k">class</span> <span class="nc">RodauthMain</span> <span class="o">&lt;</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Auth</span>
  <span class="n">configure</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">sms_send</span> <span class="k">do</span> <span class="o">|</span><span class="n">phone</span><span class="p">,</span> <span class="n">message</span><span class="o">|</span>
      <span class="c1"># we need to implement this</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We‚Äôll use <a href="https://www.twilio.com/">Twilio</a> for sending SMS messages. Assuming we‚Äôve set up an account,
we‚Äôll add the account SID, auth token, and phone number to Rails credentials:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rails credentials:edit
</code></pre></div></div>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">twilio</span><span class="pi">:</span>
  <span class="na">account_sid</span><span class="pi">:</span> <span class="s">&lt;YOUR_ACCOUNT_SID&gt;</span>
  <span class="na">auth_token</span><span class="pi">:</span> <span class="s">&lt;YOUR_AUTH_TOKEN&gt;</span>
  <span class="na">phone_number</span><span class="pi">:</span> <span class="s">&lt;YOUR_PHONE_NUMBER&gt;</span>
</code></pre></div></div>

<p>Next, we‚Äôll install the <a href="https://github.com/twilio/twilio-ruby">twilio-ruby</a> gem, and create a wrapper class for the
Twilio client that uses the configured credentials:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle add twilio-ruby
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/misc/twilio_client.rb</span>
<span class="k">class</span> <span class="nc">TwilioClient</span>
  <span class="no">Error</span>              <span class="o">=</span> <span class="no">Class</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">StandardError</span><span class="p">)</span>
  <span class="no">InvalidPhoneNumber</span> <span class="o">=</span> <span class="no">Class</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Error</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@account_sid</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">twilio</span><span class="p">.</span><span class="nf">account_sid!</span>
    <span class="vi">@auth_token</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">twilio</span><span class="p">.</span><span class="nf">auth_token!</span>
    <span class="vi">@phone_number</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">twilio</span><span class="p">.</span><span class="nf">phone_number!</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">send_sms</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">from: </span><span class="vi">@phone_number</span><span class="p">,</span> <span class="ss">to: </span><span class="n">to</span><span class="p">,</span> <span class="ss">body: </span><span class="n">message</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">Twilio</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">RestError</span> <span class="o">=&gt;</span> <span class="n">error</span>
    <span class="c1"># more details here: https://www.twilio.com/docs/api/errors/21211</span>
    <span class="k">raise</span> <span class="no">TwilioClient</span><span class="o">::</span><span class="no">InvalidPhoneNumber</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="nf">message</span> <span class="k">if</span> <span class="n">error</span><span class="p">.</span><span class="nf">code</span> <span class="o">==</span> <span class="mi">21211</span>
    <span class="k">raise</span> <span class="no">TwilioClient</span><span class="o">::</span><span class="no">Error</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="nf">message</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">client</span>
    <span class="no">Twilio</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@account_sid</span><span class="p">,</span> <span class="vi">@auth_token</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Finally, we‚Äôll implement <code class="language-plaintext highlighter-rouge">sms_send</code> using our new <code class="language-plaintext highlighter-rouge">TwilioClient</code> class. We‚Äôll
convert SMS sending errors into validation errors, making sure we roll back
the wrapping database transaction to prevent phone number &amp; code from being
persisted:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/misc/rodauth_main.rb</span>
<span class="k">class</span> <span class="nc">RodauthMain</span> <span class="o">&lt;</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">Auth</span>
  <span class="n">configure</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">sms_send</span> <span class="k">do</span> <span class="o">|</span><span class="n">phone</span><span class="p">,</span> <span class="n">message</span><span class="o">|</span>
      <span class="n">twilio</span> <span class="o">=</span> <span class="no">TwilioClient</span><span class="p">.</span><span class="nf">new</span>
      <span class="n">twilio</span><span class="p">.</span><span class="nf">send_sms</span><span class="p">(</span><span class="n">phone</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="k">rescue</span> <span class="no">TwilioClient</span><span class="o">::</span><span class="no">Error</span> <span class="o">=&gt;</span> <span class="n">error</span>
      <span class="n">db</span><span class="p">.</span><span class="nf">rollback_on_exit</span>
      <span class="n">throw_error_status</span><span class="p">(</span><span class="mi">422</span><span class="p">,</span> <span class="n">sms_phone_param</span><span class="p">,</span> <span class="n">sms_invalid_phone_message</span><span class="p">)</span> <span class="k">if</span> <span class="n">error</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">TwilioClient</span><span class="o">::</span><span class="no">InvalidPhoneNumber</span><span class="p">)</span>
      <span class="n">throw_error_status</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">sms_phone_param</span><span class="p">,</span> <span class="s2">"sending the SMS code failed"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When the user now visits the SMS authentication setup page on the multifactor
manage page, they can enter their phone number and password, and then enter the
SMS code they received to finish the SMS authentication setup.</p>

<p><img src="/images/rodauth-sms-setup.png" alt="Rodauth SMS authentication setup page" /></p>

<p>Afterwards, when the user logs in the next time, in addition to authenticating
via TOTP or a recovery code, they‚Äôll now also be able to choose to authenticate
via SMS.</p>

<h2 id="disabling-multifactor-authentication">Disabling multifactor authentication</h2>

<p>In addition to setup and authentication, Rodauth also provides endpoints for
disabling any MFA method, which require the user to confirm their password:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/otp-disable</code> ‚Äì disable OTP authentication</li>
  <li><code class="language-plaintext highlighter-rouge">/sms-disable</code> ‚Äì disable multifactor authentication</li>
  <li><code class="language-plaintext highlighter-rouge">/multifactor-disable</code> ‚Äì disable all multifactor methods</li>
</ul>

<p>The links for disabling MFA methods that have previously been set up are
automatically displayed on the multifactor manage page:</p>

<p><img src="/images/rodauth-mfa-disable.png" alt="Rodauth links for disabling configured MFA methods" /></p>

<p>Disabling a MFA method will take care of deleting any records associated to
that account from the corresponding database table.</p>

<h2 id="closing-words">Closing words</h2>

<p>In this tutorial we‚Äôve shown how to add multifactor authentication
functionality in Rails with Rodauth and rodauth-rails. We‚Äôve enabled the
user to set up TOTP as their primary MFA method, after which they receive a set
of recovery codes, and have the possibility to also set up SMS as a backup MFA
method.</p>

<p>We‚Äôve seen that Rodauth ships with complete endpoints and default HTML
templates for managing multiple MFA methods, and generally provides a much more
integrated experience compared to the alternatives. Given that multifactor
authentication is becoming an increasingly common requirement, it‚Äôs very useful
to have a framework that supports it with the same level of standard as the
other authentication features.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>At the time of writing, most popular alternatives are <a href="https://github.com/tinfoil/devise-two-factor">devise-two-factor</a>, <a href="https://github.com/heapsource/active_model_otp">active_model_otp</a>, and <a href="https://github.com/Houdini/two_factor_authentication">two_factor_authentication</a>.¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>See the source code for <a href="https://github.com/jeremyevans/rodauth/blob/master/lib/rodauth/features/otp.rb">OTP</a>, <a href="https://github.com/jeremyevans/rodauth/blob/master/lib/rodauth/features/sms_codes.rb">SMS Codes</a>, <a href="https://github.com/jeremyevans/rodauth/blob/master/lib/rodauth/features/recovery_codes.rb">Recovery Codes</a>, and <a href="https://github.com/jeremyevans/rodauth/blob/master/lib/rodauth/features/two_factor_base.rb">Two Factor Base</a> for more details.¬†<a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>You can override the default template by running <code class="language-plaintext highlighter-rouge">rails generate rodauth:views otp</code> and modifying <code class="language-plaintext highlighter-rouge">app/views/rodauth/otp_setup.html.erb</code>.¬†<a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>
</article>

<div class="mt-8 md:mt-10">
  
  <script src="https://utteranc.es/client.js"
          repo="janko/janko.io"
          issue-term="title"
          theme="github-light"
          crossorigin="anonymous"
          async>
  </script>


</div>

      </main>
    </div>

    
      <script>
  // Gauges
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '51f5bd47f5a1f545ac0000fc');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://bouncy-van.janko.io/script.js" data-site="EKJCVCTX" defer></script>
<!-- / Fathom -->

    
  </body>
</html>
