<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Upcoming Features in Shrine 3.0 | Janko's Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Upcoming Features in Shrine 3.0" />
<meta name="author" content="Janko Marohniƒá" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The last couple of months I‚Äôve been working hard to prepare for Shrine 3.0, which I expect will be released by the end of October. A lot of work has gone into it, including some big but much needed rewrites. I feel the API has stabilized now, so I thought it would be a good time to share with your some of the new features and improvements that will be coming to 3.0. :tada:" />
<meta property="og:description" content="The last couple of months I‚Äôve been working hard to prepare for Shrine 3.0, which I expect will be released by the end of October. A lot of work has gone into it, including some big but much needed rewrites. I feel the API has stabilized now, so I thought it would be a good time to share with your some of the new features and improvements that will be coming to 3.0. :tada:" />
<link rel="canonical" href="https://janko.io/upcoming-features-in-shrine-3-0/" />
<meta property="og:url" content="https://janko.io/upcoming-features-in-shrine-3-0/" />
<meta property="og:site_name" content="Janko‚Äôs Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-08-29T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Upcoming Features in Shrine 3.0" />
<meta name="twitter:site" content="@jankomarohnic" />
<meta name="twitter:creator" content="@jankomarohnic" />
<meta property="article:publisher" content="https://www.facebook.com/janko.marohnic/" />
<script type="application/ld+json">
{"@type":"BlogPosting","description":"The last couple of months I‚Äôve been working hard to prepare for Shrine 3.0, which I expect will be released by the end of October. A lot of work has gone into it, including some big but much needed rewrites. I feel the API has stabilized now, so I thought it would be a good time to share with your some of the new features and improvements that will be coming to 3.0. :tada:","headline":"Upcoming Features in Shrine 3.0","dateModified":"2019-08-29T00:00:00+02:00","datePublished":"2019-08-29T00:00:00+02:00","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://janko.io/images/logo.png"},"name":"Janko Marohniƒá"},"url":"https://janko.io/upcoming-features-in-shrine-3-0/","mainEntityOfPage":{"@type":"WebPage","@id":"https://janko.io/upcoming-features-in-shrine-3-0/"},"author":{"@type":"Person","name":"Janko Marohniƒá"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="https://janko.io/feed.xml" title="Janko&apos;s Blog" />
    <link rel="stylesheet" href="/css/bundle.css">
  </head>

  <body class="text-xl text-gray-700">
    <header class="py-3 px-4 flex flex-col space-y-1 bg-gray-100 border-b">
      <div class="flex justify-center">
        <a class="flex items-center space-x-2" href="/">
          <img class="h-8" src="/images/logo.png" alt="logo">
          <span class="text-2xl md:text-3xl font-semibold text-pink-700">Janko's Blog</span>
        </a>
      </div>
      <div class="flex justify-center">
        <span class="text-base md:text-lg text-gray-500">Sharing the wonders of Ruby
      </span>
</div>
    </header>

    <div class="text-center py-3 bg-sky-50 border-b border-sky-100 text-sky-600">
      Dear Russian friends, please watch President Zelenskyy's <a href="https://www.youtube.com/watch?v=p-zilnPtZ2M" class="underline text-blue-600 hover:text-blue-500">speech addressed to you</a>.
      üá∫üá¶ Support Ukraine by <a href="https://war.ukraine.ua/support-ukraine/" class="underline text-yellow-600 hover:text-yellow-500">donating</a> to humanitarian aid.
    </div>

    <div class="my-6 sm:my-8 mx-4">
      <main class="max-w-screen-sm md:max-w-screen-md mx-auto">
        <article>
  <header class="space-y-4 md:space-y-5">
    <h1 class="lg:-mx-28 text-3xl sm:text-4xl lg:text-5xl text-center font-medium text-gray-900">Upcoming Features in Shrine 3.0</h1>

    <div class="flex justify-center">
      <div class="flex flex-col items-center sm:flex-row sm:items-baseline space-y-3 sm:space-y-0 sm:space-x-4 text-sm md:text-base">
        <span class="text-gray-500">
          By <a class="underline hover:text-gray-700" href="/about">Janko Marohniƒá</a> on
          <time datetime="2019-08-29 00:00:00 +0200">
            29 Aug 2019
          </time>
        </span>
        
          
<a class="my-1 rounded-full px-3 bg-red-100 text-red-700 font-semibold py-0.5" href="/shrine">shrine</a>


        
      </div>
    </div>
  </header>

  <div class="mt-4 sm:mt-6 markdown">
    <p>The last couple of months I‚Äôve been working hard to prepare for <a href="https://shrinerb.com/docs/release_notes/3.0.0">Shrine 3.0</a>,
which I expect will be released by the end of October. A lot of work has gone
into it, including some big but much needed rewrites. I feel the API has
stabilized now, so I thought it would be a good time to share with your some of
the new features and improvements that will be coming to 3.0. <img class="emoji" title=":tada:" alt=":tada:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png" height="20" width="20"></p>

<p>For those who don‚Äôt know, <a href="https://shrinerb.com/">Shrine</a> is a versatile file attachment library for
Ruby applications. It was born out of frustration for not being able to achieve
the desired user experience with existing solutions. Tomorrow it will be
turning 4 years old. <img class="emoji" title=":smiley:" alt=":smiley:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f603.png" height="20" width="20"></p>

<p>Before we start, here is a little refresher on Shrine‚Äôs core classes:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Class</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Shrine</code></td>
      <td style="text-align: left">performs uploads</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Shrine::UploadedFile</code></td>
      <td style="text-align: left">represents uploaded files</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Shrine::Attacher</code></td>
      <td style="text-align: left">handles attaching</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Shrine::Attachment</code></td>
      <td style="text-align: left">model wrapper for <code class="language-plaintext highlighter-rouge">Shrine::Attacher</code>
</td>
    </tr>
  </tbody>
</table>

<h2 id="decoupling-from-models">Decoupling from models</h2>

<p>Currently, when attaching files, Shrine requires you to provide a mutable
struct (aka ‚Äúmodel‚Äù) which the attached file data will be written to:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:image_data</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">new</span>

<span class="n">attacher</span> <span class="o">=</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="ss">:image</span><span class="p">)</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1"># uploads file</span>

<span class="n">photo</span><span class="p">.</span><span class="nf">image_data</span> <span class="c1">#=&gt; '{"id":"abc123.jpg", "storage":"cache", "metadata":{...}}'</span>
</code></pre></div></div>

<p>This works nicely with Active Record, Sequel, Mongoid and all other database
libraries that implement the <a href="https://www.martinfowler.com/eaaCatalog/activeRecord.html">Active Record pattern</a>.</p>

<p>However, it so happens that not all Ruby database libraries implement this
pattern. <a href="https://rom-rb.org/">ROM</a> and <a href="https://github.com/hanami/model">Hanami::Model</a> implement the <a href="https://martinfowler.com/eaaCatalog/repository.html">Repository pattern</a>, which
separates data from persistence. Using this pattern, record objects (aka
‚Äúentities‚Äù) are represented with <em>immutable</em> structs:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">Hanami</span><span class="o">::</span><span class="no">Entity</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">image_data: </span><span class="kp">nil</span><span class="p">)</span>

<span class="n">attacher</span> <span class="o">=</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="ss">:image</span><span class="p">)</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1">#~&gt; NoMethodError: undefined method `image_data=' for #&lt;Photo&gt;</span>
</code></pre></div></div>

<p>You could somehow <a href="https://github.com/katafrakt/hanami-shrine/blob/de69815c6a609e87bb524c0a865cd46585bc30cb/lib/shrine/plugins/hanami.rb#L12-L40">hack your way around it</a>, but this is
far from ideal. Even if I didn‚Äôt care about ROM and Hanami::Model, I did feel
that coupling to model instances made the <code class="language-plaintext highlighter-rouge">Shrine::Attacher</code> implementation
more difficult to reason about. When that reached a point where we
<a href="https://github.com/shrinerb/shrine/pull/295">couldn‚Äôt</a> <a href="https://github.com/shrinerb/shrine/pull/299">implement</a> the new
<a href="#derivatives">derivatives</a> feature, I knew that attaching logic needed to be
rewritten.</p>

<p>The result of that rewrite is that the <code class="language-plaintext highlighter-rouge">Shrine::Attacher</code> API is now layered
into <a href="#base">base</a>, <a href="#column">column</a>, <a href="#entity">entity</a>, and <a href="#model">model</a>.</p>

<h3 id="base">Base</h3>

<p>The core <code class="language-plaintext highlighter-rouge">Shrine::Attacher</code> is now instantiated standalone and maintains its
own state:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">attacher</span> <span class="o">=</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">new</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1"># uploads file</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">file</span> <span class="c1">#=&gt; #&lt;Shrine::UploadedFile id="abc123.jpg" storage=:store ...&gt;</span>
</code></pre></div></div>

<p>It provides the <code class="language-plaintext highlighter-rouge">#data</code> method which returns attached file data as a
serializable Hash, suitable for persisting:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">attacher</span><span class="p">.</span><span class="nf">data</span> <span class="c1">#=&gt;</span>
<span class="c1"># {</span>
<span class="c1">#   "id" =&gt; "abc123.jpg",</span>
<span class="c1">#   "storage" =&gt; "store",</span>
<span class="c1">#   "metadata" =&gt; {</span>
<span class="c1">#     "size" =&gt; 9534842,</span>
<span class="c1">#     "filename" =&gt; "nature.jpg",</span>
<span class="c1">#     "mime_type" =&gt; "image/jpeg",</span>
<span class="c1">#   }</span>
<span class="c1"># }</span>
</code></pre></div></div>

<p>The attachment can then be loaded back from this data:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">attacher</span> <span class="o">=</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">from_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">file</span> <span class="c1">#=&gt; #&lt;Shrine::UploadedFile @id="abc123.jpg" @storage_key=:store ...&gt;</span>
</code></pre></div></div>

<h3 id="column">Column</h3>

<p>Now, if you want to persist the attached file data to a text database column,
you‚Äôll need to <strong>serialize</strong> the data hash into a string (e.g. JSON). For that
you can use the <code class="language-plaintext highlighter-rouge">column</code> plugin:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:column</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="n">attacher</span><span class="p">.</span><span class="nf">column_data</span> <span class="c1"># dump JSON string</span>
<span class="c1">#=&gt; '{"id":"abc123.jpg","storage":"store","metadata":{...}}'</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">attacher</span> <span class="o">=</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">from_column</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># load JSON string</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">file</span> <span class="c1">#=&gt; #&lt;Shrine::UploadedFile id="abc123.jpg" storage=:store ...&gt;</span>
</code></pre></div></div>

<h3 id="entity">Entity</h3>

<p>The <code class="language-plaintext highlighter-rouge">entity</code> plugin builds upon the <code class="language-plaintext highlighter-rouge">column</code> plugin, providing integration for
<strong>immutable</strong> structs:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">Hanami</span><span class="o">::</span><span class="no">Entity</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">image_data: </span><span class="kp">nil</span><span class="p">)</span>

<span class="c1"># allows instantiating attacher from an entity</span>
<span class="n">attacher</span> <span class="o">=</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">from_entity</span><span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="ss">:image</span><span class="p">)</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1"># does not attempt to write to the entity attribute</span>

<span class="c1"># provides the hash of attributes for you to persist</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">column_values</span> <span class="c1">#=&gt; { :image_data =&gt; '{"id":"abc123.jpg","storage":"cache","metadata":{...}}' }</span>
</code></pre></div></div>

<p>You can remove some of the boilerplate with the <code class="language-plaintext highlighter-rouge">Shrine::Attachment</code> module:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">Hanami</span><span class="o">::</span><span class="no">Entity</span>
  <span class="kp">include</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">Attachment</span><span class="p">(</span><span class="ss">:image</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">image_data: </span><span class="s1">'{"id":"abc123.jpg","storage":"store","metadata":{...}}'</span><span class="p">)</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="c1">#=&gt; #&lt;Shrine::UploadedFile id="abc123.jpg" storage=:store ...&gt;</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image_attacher</span> <span class="c1"># shorthand for `Shrine::Attacher.from_entity(photo, :image)`</span>
</code></pre></div></div>

<p>The upcoming <code class="language-plaintext highlighter-rouge">shrine-rom</code> gem will build upon the <code class="language-plaintext highlighter-rouge">entity</code> plugin, as well as
the <a href="https://github.com/katafrakt/hanami-shrine"><code class="language-plaintext highlighter-rouge">hanami-shrine</code></a> gem.</p>

<h3 id="model">Model</h3>

<p>With the <code class="language-plaintext highlighter-rouge">entity</code> plugin providing the reads, the new <code class="language-plaintext highlighter-rouge">model</code> plugin adds the
writes, which is convenient for <strong>mutable</strong> structs:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:image_data</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">new</span>

<span class="c1"># allows instantiating attacher from a model</span>
<span class="n">attacher</span> <span class="o">=</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">from_model</span><span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="ss">:image</span><span class="p">)</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1"># writes uploaded file data to the model attribute</span>

<span class="n">photo</span><span class="p">.</span><span class="nf">image_data</span> <span class="c1">#=&gt; #=&gt; '{"id":"abc123.jpg", "storage":"cache", "metadata":{...}}'</span>
</code></pre></div></div>

<p>Or with the <code class="language-plaintext highlighter-rouge">Shrine::Attachment</code> module:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Photo</span> <span class="o">&lt;</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:image_data</span><span class="p">)</span>
  <span class="kp">include</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">Attachment</span><span class="p">(</span><span class="ss">:image</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">new</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="n">file</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="c1">#=&gt; #&lt;Shrine::UploadedFile id="abc123.jpg" storage=:cache ...&gt;</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image_data</span> <span class="c1">#=&gt; #=&gt; '{"id":"abc123.jpg", "storage":"cache", "metadata":{...}}'</span>
</code></pre></div></div>

<p>The existing <a href="https://shrinerb.com/docs/plugins/activerecord"><code class="language-plaintext highlighter-rouge">activerecord</code></a> and <a href="https://shrinerb.com/docs/plugins/sequel"><code class="language-plaintext highlighter-rouge">sequel</code></a> plugins are
then built on top of the <code class="language-plaintext highlighter-rouge">model</code> plugin.</p>

<h2 id="derivatives">Derivatives</h2>

<p>The <code class="language-plaintext highlighter-rouge">Shrine::Attacher</code> rewrite also enabled us to implement the main new
feature ‚Äì the <a href="https://shrinerb.com/docs/plugins/derivatives">derivatives</a> plugin. It is a reimplementation
of the existing <a href="https://shrinerb.com/docs/plugins/versions"><code class="language-plaintext highlighter-rouge">versions</code></a> plugin, but with a proper API and much
needed flexibility.</p>

<h3 id="problems-with-versions">Problems with versions</h3>

<p>The <code class="language-plaintext highlighter-rouge">versions</code> plugin works in a way that you register a processing block,
which receives the original cached file and needs to return the set of files
that should be saved. This block is automatically triggered when the cached
file is being uploaded to permanent storage.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">Shrine</span>
  <span class="n">plugin</span> <span class="ss">:processing</span>
  <span class="n">plugin</span> <span class="ss">:versions</span>

  <span class="n">process</span><span class="p">(</span><span class="ss">:store</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="no">ImageProcessing</span><span class="o">::</span><span class="no">MiniMagick</span><span class="p">.</span><span class="nf">source</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">download</span><span class="p">)</span>

    <span class="p">{</span> <span class="ss">original: </span><span class="n">io</span><span class="p">,</span>
      <span class="ss">large:    </span><span class="n">processor</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span>
      <span class="ss">medium:   </span><span class="n">processor</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
      <span class="ss">small:    </span><span class="n">processor</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="n">file</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">save</span>  <span class="c1"># triggers processing of versions</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="c1">#=&gt;</span>
<span class="c1"># {</span>
<span class="c1">#   original: &lt;Shrine::UploadedFile @id="original.jpg" ...&gt;,</span>
<span class="c1">#   large:    &lt;Shrine::UploadedFile @id="large.jpg" ...&gt;,</span>
<span class="c1">#   medium:   &lt;Shrine::UploadedFile @id="medium.jpg" ...&gt;,</span>
<span class="c1">#   small:    &lt;Shrine::UploadedFile @id="small.jpg" ...&gt;,</span>
<span class="c1"># }</span>
</code></pre></div></div>

<p>One problem with this design is that you needed to change how you access your
original file after the versions has been processed. This is especially
problematic when processing in a <a href="https://shrinerb.com/docs/plugins/backgrounding">background job</a>, as then you
need to handle both attachment states, with and without versions.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># how we access the original file...</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="c1">#=&gt; #&lt;Shrine::UploadedFile @id="original.jpg" ...&gt;</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">mime_type</span> <span class="c1">#=&gt; "image/jpeg"</span>

<span class="n">photo</span><span class="p">.</span><span class="nf">save</span>

<span class="c1"># ...now needs to be changed</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span><span class="p">[</span><span class="ss">:original</span><span class="p">]</span> <span class="c1">#=&gt; #&lt;Shrine::UploadedFile @id="original.jpg" ...&gt;</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span><span class="p">[</span><span class="ss">:original</span><span class="p">].</span><span class="nf">mime_type</span> <span class="c1">#=&gt; "image/jpeg"</span>
</code></pre></div></div>

<p>The fact that processing versions was tied to promotion made other things
difficult as well:</p>

<ul>
  <li>uploading versions to a different storage than the original file</li>
  <li>adding new versions to an existing attachment</li>
  <li>reprocessing existing versions</li>
</ul>

<h3 id="solution">Solution</h3>

<p>With the new <strong>derivatives</strong> plugin, you trigger processing explicitly when you
want, and processed files are retrieved separately from the original file:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">Shrine</span>
  <span class="n">plugin</span> <span class="ss">:derivatives</span>

  <span class="no">Attacher</span><span class="p">.</span><span class="nf">derivatives_processor</span> <span class="k">do</span> <span class="o">|</span><span class="n">original</span><span class="o">|</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="no">ImageProcessing</span><span class="o">::</span><span class="no">MiniMagick</span><span class="p">.</span><span class="nf">source</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>

    <span class="p">{</span>
      <span class="ss">large:  </span><span class="n">processor</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span>
      <span class="ss">medium: </span><span class="n">processor</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
      <span class="ss">small:  </span><span class="n">processor</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="n">file</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image_derivatives!</span> <span class="c1"># triggers processing and uploads results</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">save</span>

<span class="c1"># ...</span>

<span class="n">photo</span><span class="p">.</span><span class="nf">image_derivatives</span> <span class="c1">#=&gt;</span>
<span class="c1"># {</span>
<span class="c1">#   large:  #&lt;Shrine::UploadedFile id="large.jpg" storage=:store&gt;,</span>
<span class="c1">#   medium: #&lt;Shrine::UploadedFile id="medium.jpg" storage=:store&gt;,</span>
<span class="c1">#   small:  #&lt;Shrine::UploadedFile id="small.jpg" storage=:store&gt;,</span>
<span class="c1"># }</span>

<span class="c1"># original file is still accessed in the same way</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="c1">#=&gt; #&lt;Shrine::UploadedFile @id="original.jpg" ...&gt;</span>
</code></pre></div></div>

<p>The processing block is just a convention, we can also add files directly using
<code class="language-plaintext highlighter-rouge">Attacher#add_derivative(s)</code>:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">attacher</span> <span class="o">=</span> <span class="n">photo</span><span class="p">.</span><span class="nf">image_attacher</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">derivatives</span> <span class="c1">#=&gt; { small: ..., medium: ..., large: ... }</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">add_derivative</span><span class="p">(</span><span class="ss">:extra_large</span><span class="p">,</span> <span class="n">extra_large_file</span><span class="p">)</span> <span class="c1"># uploads file and merges result</span>
<span class="n">attacher</span><span class="p">.</span><span class="nf">derivatives</span> <span class="c1">#=&gt; { small: ..., medium: ..., large: ..., extra_large: ... }</span>
</code></pre></div></div>

<p>The storage where processed files will be uploaded to can now be changed as
well:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># upload all derivatives to :thumbnail_store</span>
<span class="n">plugin</span> <span class="ss">:derivatives</span><span class="p">,</span> <span class="ss">storage: :thumbnail_store</span>

<span class="c1"># upload different derivatives to different storage</span>
<span class="n">plugin</span> <span class="ss">:derivatives</span><span class="p">,</span> <span class="ss">storage: </span><span class="o">-&gt;</span> <span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
</code></pre></div></div>

<h2 id="backgrounding">Backgrounding</h2>

<p>Shrine‚Äôs <a href="https://shrinerb.com/docs/plugins/backgrounding"><code class="language-plaintext highlighter-rouge">backgrounding</code></a> plugin allows you to delay uploading
cached file to permanent storage and file processing into a background job.
Previously, it tried to do everything for you ‚Äì fetch the record in the
background job, perform processing, reload the record to check that the
attachment hasn‚Äôt changed ‚Äì which meant when something <a href="https://github.com/shrinerb/shrine/issues/236">wouldn‚Äôt</a> <a href="https://github.com/shrinerb/shrine/issues/333">work</a>, you had very little visibility as to why.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:backgrounding</span>
<span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">promote_block</span> <span class="p">{</span> <span class="o">|</span><span class="n">data</span><span class="o">|</span> <span class="no">PromoteJob</span><span class="p">.</span><span class="nf">perform_async</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span> <span class="c1"># magic hash</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PromoteJob</span>
  <span class="kp">include</span> <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Worker</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">promote</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># use the magic hash to do magic things</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>For Shrine 3.0, the backgrounding feature has been completely rewritten to be
more explicit and flexible:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:backgrounding</span>
<span class="no">Shrine</span><span class="o">::</span><span class="no">Attacher</span><span class="p">.</span><span class="nf">promote_block</span> <span class="k">do</span>
  <span class="no">PromoteJob</span><span class="p">.</span><span class="nf">perform_async</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">record</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">record</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">file_data</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PromoteJob</span>
  <span class="kp">include</span> <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Worker</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">attacher_class</span><span class="p">,</span> <span class="n">record_class</span><span class="p">,</span> <span class="n">record_id</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">file_data</span><span class="p">)</span>
    <span class="n">attacher_class</span> <span class="o">=</span> <span class="no">Object</span><span class="p">.</span><span class="nf">const_get</span><span class="p">(</span><span class="n">attacher_class</span><span class="p">)</span>
    <span class="n">record</span>         <span class="o">=</span> <span class="no">Object</span><span class="p">.</span><span class="nf">const_get</span><span class="p">(</span><span class="n">record_class</span><span class="p">).</span><span class="nf">find</span><span class="p">(</span><span class="n">record_id</span><span class="p">)</span>

    <span class="n">attacher</span> <span class="o">=</span> <span class="n">attacher_class</span><span class="p">.</span><span class="nf">retrieve</span><span class="p">(</span><span class="ss">model: </span><span class="n">record</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">,</span> <span class="ss">file: </span><span class="n">file_data</span><span class="p">)</span>
    <span class="n">attacher</span><span class="p">.</span><span class="nf">atomic_promote</span>
  <span class="k">rescue</span> <span class="no">Shrine</span><span class="o">::</span><span class="no">AttachmentChanged</span><span class="p">,</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span>
    <span class="c1"># attachment has changed or the record has been deleted, nothing to do</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can now see what‚Äôs going on:</p>

<ol>
  <li>record, attachment name, and current attached file are passed to the background job</li>
  <li>background job fetches the database record</li>
  <li>you retrieve the attacher as it was before the background job was spawned
    <ul>
      <li>if attachment has changed, <code class="language-plaintext highlighter-rouge">Shrine::AttachmentChanged</code> is raised</li>
    </ul>
  </li>
  <li>you upload the cached attached file to permanent storage
    <ul>
      <li>if attachment has changed during upload, <code class="language-plaintext highlighter-rouge">Shrine::AttachmentChanged</code> is raised</li>
      <li>if record has been deleted, <code class="language-plaintext highlighter-rouge">ActiveRecord::RecordNotFound</code> is raised</li>
    </ul>
  </li>
</ol>

<p>It‚Äôs now easy for example to add processing <a href="#derivatives">derivatives</a> into
the mix:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">attacher_class</span><span class="p">,</span> <span class="n">record_class</span><span class="p">,</span> <span class="n">record_id</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">file_data</span><span class="p">)</span>
  <span class="c1"># ...</span>
  <span class="n">attacher</span> <span class="o">=</span> <span class="n">attacher_class</span><span class="p">.</span><span class="nf">retrieve</span><span class="p">(</span><span class="ss">model: </span><span class="n">record</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">,</span> <span class="ss">file: </span><span class="n">file_data</span><span class="p">)</span>
  <span class="n">attacher</span><span class="p">.</span><span class="nf">create_derivatives</span> <span class="c1"># process derivatives and store results</span>
  <span class="n">attacher</span><span class="p">.</span><span class="nf">atomic_promote</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>People have also wanted to pass additional parameters from the controller into
the background job. You can now do this with instance-level hooks:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PhotosController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">photo_params</span><span class="p">)</span>

    <span class="n">photo</span><span class="p">.</span><span class="nf">image_attacher</span><span class="p">.</span><span class="nf">promote_block</span> <span class="k">do</span> <span class="o">|</span><span class="n">attacher</span><span class="o">|</span>
      <span class="c1"># explicit style without instance eval</span>
      <span class="no">PromoteJob</span><span class="p">.</span><span class="nf">perform_async</span><span class="p">(</span>
        <span class="n">attacher</span><span class="p">.</span><span class="nf">class</span><span class="p">,</span>
        <span class="n">attacher</span><span class="p">.</span><span class="nf">record</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
        <span class="n">attacher</span><span class="p">.</span><span class="nf">record</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
        <span class="n">attacher</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
        <span class="n">attacher</span><span class="p">.</span><span class="nf">file_data</span><span class="p">,</span>
        <span class="n">current_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="c1"># pass data from the controller</span>
      <span class="p">)</span>
    <span class="k">end</span>

    <span class="n">photo</span><span class="p">.</span><span class="nf">save</span> <span class="c1"># background job is spawned</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="other-improvements">Other improvements</h2>

<p>In addition to these big rewrites, there have been many other notable
improvements in areas of usability, performance and design. Here are some of
the highlights:</p>

<h3 id="skipping-temporary-storage">Skipping temporary storage</h3>

<p>Shrine uses a temporary storage for storing files that have not been attached
yet. This enables features such as retaining uploads on validation errors and
<a href="https://shrinerb.com/docs/getting-started#direct-uploads">direct uploads</a>.</p>

<p>However, if you‚Äôre attaching files from a background job or a script, you don‚Äôt
need the temporary storage. Starting from Shrine 3.0, you won‚Äôt need to have
temporary storage defined, and you can change attachment writer method to
upload directly to permanent storage:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:model</span><span class="p">,</span> <span class="ss">cache: </span><span class="kp">false</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="n">file</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">storage_key</span> <span class="c1">#=&gt; :store (permanent storage)</span>
</code></pre></div></div>

<h3 id="faster-file-retrieval">Faster file retrieval</h3>

<p>Currently, whenever the attached file is accessed, it‚Äôs parsed from the
attachment data attribute on the record instance. This can add up if you‚Äôre
storing lots of processed files or metadata.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="c1"># parses `image_data` column attribute</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="c1"># parses `image_data` column attribute again</span>
</code></pre></div></div>

<p>Starting from Shrine 3.0, the attached file will be loaded from the data
attribute only on first access. Additionally, you‚Äôll be able to switch to a
faster JSON parser if you want to.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"oj"</span> <span class="c1"># https://github.com/ohler55/oj</span>

<span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:column</span><span class="p">,</span> <span class="ss">serializer: </span><span class="no">Oj</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="c1"># parses `image_data` using Oj, and memoizes the result</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span> <span class="c1"># returns memoized file</span>
</code></pre></div></div>

<h3 id="standardized-persistence-api">Standardized persistence API</h3>

<p>The persistence API has now been standardized across different persistence
plugins:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Method</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Attacher#persist</code></td>
      <td style="text-align: left">persists attachment data</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Attacher#atomic_persist</code></td>
      <td style="text-align: left">persists attachment data if attachment hasn‚Äôt changed</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Attacher#atomic_promote</code></td>
      <td style="text-align: left">promotes cached file and atomically persists changes</td>
    </tr>
  </tbody>
</table>

<p>All persistence plugins will now share this API:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">activerecord</code></li>
  <li><code class="language-plaintext highlighter-rouge">sequel</code></li>
  <li><code class="language-plaintext highlighter-rouge">mongoid</code></li>
  <li><code class="language-plaintext highlighter-rouge">rom</code></li>
  <li><code class="language-plaintext highlighter-rouge">hanami</code></li>
  <li>‚Ä¶</li>
</ul>

<p>This will make it easier for 3rd-party plugins to be agnostic to your
persistence backend, as they‚Äôll be able to just call <code class="language-plaintext highlighter-rouge">Attacher#persist</code> and
know it will do the right thing. It even works if the user has multiple
persistence plugins loaded simultaneously.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I still stand strong by the decision that Shrine will never paint you into a
corner, regardless of which database library and web framework you‚Äôre using, or
which design patterns you prefer. At times following this philosophy can be
very challenging, but ultimately it‚Äôs very rewarding, because you know you‚Äôve
ended up with a design that‚Äôs really solid. <img class="emoji" title=":muscle:" alt=":muscle:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f4aa.png" height="20" width="20"></p>

<p>I‚Äôve released <code class="language-plaintext highlighter-rouge">3.0.0.beta</code> with these new changes, so if you want you can
already use them:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gem <span class="nb">install</span> <span class="nt">--pre</span> shrine
Successfully installed shrine-3.0.0.beta
</code></pre></div></div>

<p>I still need to finish up the backwards compatibility layer, write the
upgrading guide and full release notes, as well as finish updating the
documentation and other <code class="language-plaintext highlighter-rouge">shrine-*</code> gems. Once that‚Äôs done, Shrine 3.0 should be
out the doors. <img class="emoji" title=":sparkles:" alt=":sparkles:" src="https://github.githubassets.com/images/icons/emoji/unicode/2728.png" height="20" width="20"></p>


  </div>
</article>

<div class="mt-8 md:mt-10">
  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'twinblog'; // required: replace example with your forum shortname
    var disqus_identifier = '/upcoming-features-in-shrine-3-0';
    var disqus_url = 'https://janko.io/upcoming-features-in-shrine-3-0/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</div>

      </main>
    </div>

    
      <script>
  // Gauges
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '51f5bd47f5a1f545ac0000fc');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>

    
  </body>
</html>
