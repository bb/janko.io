<!DOCTYPE html>
<html class="no-js wf-loading" lang="en">
  <head>
    <meta charset="utf-8">
    <title>Better File Uploads with Shrine: Metadata | Janko's Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Better File Uploads with Shrine: Metadata" />
<meta name="author" content="Janko Marohnić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is the 5th part of a series of blog posts about Shrine. In this part I talk about how Shrine extracts and stores file metadata." />
<meta property="og:description" content="This is the 5th part of a series of blog posts about Shrine. In this part I talk about how Shrine extracts and stores file metadata." />
<link rel="canonical" href="https://janko.io/better-file-uploads-with-shrine-metadata/" />
<meta property="og:url" content="https://janko.io/better-file-uploads-with-shrine-metadata/" />
<meta property="og:site_name" content="Janko’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-11-07T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Better File Uploads with Shrine: Metadata" />
<meta name="twitter:site" content="@jankomarohnic" />
<meta name="twitter:creator" content="@jankomarohnic" />
<meta property="article:publisher" content="https://www.facebook.com/janko.marohnic/" />
<script type="application/ld+json">
{"@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://janko.io/images/logo.png"},"name":"Janko Marohnić"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://janko.io/better-file-uploads-with-shrine-metadata/"},"author":{"@type":"Person","name":"Janko Marohnić"},"headline":"Better File Uploads with Shrine: Metadata","description":"This is the 5th part of a series of blog posts about Shrine. In this part I talk about how Shrine extracts and stores file metadata.","dateModified":"2016-11-07T00:00:00+01:00","datePublished":"2016-11-07T00:00:00+01:00","url":"https://janko.io/better-file-uploads-with-shrine-metadata/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="https://janko.io/feed.xml" title="Janko's Blog" />
    
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <link rel="stylesheet" href="/css/output.css">
  </head>

  <body class="text-xl text-gray-700">
    <header class="py-3 px-4 flex flex-col space-y-1 bg-gray-100 border-b">
      <div class="flex justify-center">
        <a class="flex items-center space-x-2" href="/">
          <img class="h-8" src="/images/logo.png" alt="logo" />
          <span class="text-2xl md:text-3xl font-semibold text-pink-700">Janko's Blog</span>
        </a>
      </div>
      <div class="flex justify-center">
        <span class="text-base md:text-lg text-gray-500">Sharing the wonders of Ruby</p>
      </div>
    </header>

    <div class="mx-6">
      <main class="max-w-screen-sm lg:max-w-screen-md mx-auto">
        <article class="my-8">
  <header class="text-center my-6">
    <h1 class="lg:-mx-28 text-3xl sm:text-4xl lg:text-5xl mb-5 font-medium text-gray-900">Better File Uploads with Shrine: Metadata</h1>

    <div class="text-gray-500 text-base">
      <p class="post-byline">
        By Janko Marohnić on
        <time class="post-date" datetime="2016-11-07 00:00:00 +0100">
          07 Nov 2016
        </time>
        
          <span>
            –
            <a class="underline" href="https://github.com/janko/janko.io/commits/master/_posts/2016-11-07-better-file-uploads-with-shrine-metadata.md">
              Last edit on 15 Sep 2019
            </a>
          </span>
        
      </p>
    </div>
  </header>

  <div class="prose lg:prose-xl">
    <p>Shrine has very flexible and customizable support for saving file metadata.
Whenever Shrine is about to upload a file, it extracts available metadata from
the file, and adds it to the returned <code class="language-plaintext highlighter-rouge">Shrine::UploadedFile</code> object.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">uploaded_file</span> <span class="o">=</span> <span class="n">uploader</span><span class="p">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="n">uploaded_file</span> <span class="c1">#=&gt; #&lt;Shrine::UploadedFile&gt;</span>

<span class="n">uploaded_file</span><span class="p">.</span><span class="nf">metadata</span> <span class="c1">#=&gt;</span>
<span class="c1"># {</span>
<span class="c1">#   "filename" =&gt; "nature.jpg",</span>
<span class="c1">#   "mime_type" =&gt; "image/jpeg",</span>
<span class="c1">#   "size" =&gt; 2859343</span>
<span class="c1"># }</span>

<span class="n">uploaded_file</span><span class="p">.</span><span class="nf">original_filename</span> <span class="c1">#=&gt; "nature.jpg"</span>
<span class="n">uploaded_file</span><span class="p">.</span><span class="nf">extension</span>         <span class="c1">#=&gt; "jpg"</span>
<span class="n">uploaded_file</span><span class="p">.</span><span class="nf">mime_type</span>         <span class="c1">#=&gt; "image/jpeg"</span>
<span class="n">uploaded_file</span><span class="p">.</span><span class="nf">size</span>              <span class="c1">#=&gt; 2859343</span>
</code></pre></div></div>

<p>Most file attachments libraries have support for saving file metadata into
additional columns. However, that means that you need to have a database column
for each metadata you want to save.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This is lame</span>
<span class="n">add_column</span> <span class="ss">:photos</span><span class="p">,</span> <span class="ss">:image_filename</span><span class="p">,</span> <span class="ss">:string</span>
<span class="n">add_column</span> <span class="ss">:photos</span><span class="p">,</span> <span class="ss">:image_type</span><span class="p">,</span>     <span class="ss">:string</span>
<span class="n">add_column</span> <span class="ss">:photos</span><span class="p">,</span> <span class="ss">:image_size</span><span class="p">,</span>     <span class="ss">:integer</span>
<span class="n">add_column</span> <span class="ss">:photos</span><span class="p">,</span> <span class="ss">:image_width</span><span class="p">,</span>    <span class="ss">:integer</span>
<span class="n">add_column</span> <span class="ss">:photos</span><span class="p">,</span> <span class="ss">:image_height</span><span class="p">,</span>   <span class="ss">:integer</span>
<span class="c1"># ...</span>
</code></pre></div></div>

<p>Shrine takes a much simpler approach here. Since it uses a single
<code class="language-plaintext highlighter-rouge">&lt;attachment&gt;_data</code> database column to save the serialized
<code class="language-plaintext highlighter-rouge">Shrine::UploadedFile</code> object, any metadata included in this object will also
get saved to the same column.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span> <span class="o">=</span> <span class="no">Photo</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">image: </span><span class="n">file</span><span class="p">)</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image_data</span> <span class="c1">#=&gt;</span>
<span class="c1"># {</span>
<span class="c1">#   "id": "ee08af.jpg",</span>
<span class="c1">#   "storage": "store",</span>
<span class="c1">#   "metadata": {</span>
<span class="c1">#     "filename" =&gt; "nature.jpg",</span>
<span class="c1">#     "mime_type" =&gt; "image/jpeg",</span>
<span class="c1">#     "size" =&gt; 2859343</span>
<span class="c1">#   }</span>
<span class="c1"># }</span>
</code></pre></div></div>

<p>Furthermore, when you’re storing processed files alongside the main file,
Shrine automatically extracts and saves metadata of each file:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">Shrine</span>
  <span class="n">plugin</span> <span class="ss">:derivatives</span>

  <span class="no">Attacher</span><span class="p">.</span><span class="nf">derivatives_processor</span> <span class="k">do</span> <span class="o">|</span><span class="n">original</span><span class="o">|</span>
    <span class="n">magick</span> <span class="o">=</span> <span class="no">ImageProcessing</span><span class="o">::</span><span class="no">MiniMagick</span><span class="p">.</span><span class="nf">source</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>

    <span class="p">{</span>
      <span class="ss">small:  </span><span class="n">magick</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
      <span class="ss">medium: </span><span class="n">magick</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
      <span class="ss">large:  </span><span class="n">magick</span><span class="p">.</span><span class="nf">resize_to_limit!</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">photo</span><span class="p">.</span><span class="nf">image_derivatives!</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image_data</span>
<span class="c1"># {</span>
<span class="c1">#   "id": "ee08af.jpg",</span>
<span class="c1">#   "storage": "store",</span>
<span class="c1">#   "metadata": { ... },</span>
<span class="c1">#   "derivatives": {</span>
<span class="c1">#     "small": { "id": "f9f67a.jpg", "storage": "store", "metadata": { ... } },</span>
<span class="c1">#     "medium": { "id": "5e27cf.jpg", "storage": "store", "metadata": { ... } },</span>
<span class="c1">#     "large": { "id": "ff1da8.jpg", "storage": "store", "metadata": { ... } },</span>
<span class="c1">#   }</span>
<span class="c1"># }</span>

<span class="n">photo</span><span class="p">.</span><span class="nf">image</span><span class="p">(</span><span class="ss">:small</span><span class="p">).</span><span class="nf">size</span>  <span class="c1">#=&gt; 21496</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span><span class="p">(</span><span class="ss">:medium</span><span class="p">).</span><span class="nf">size</span> <span class="c1">#=&gt; 98237</span>
<span class="n">photo</span><span class="p">.</span><span class="nf">image</span><span class="p">(</span><span class="ss">:large</span><span class="p">).</span><span class="nf">size</span>  <span class="c1">#=&gt; 150383</span>
</code></pre></div></div>

<h2 id="mime-type">MIME type</h2>

<p>Shrine doesn’t have any mandatory dependency for extracting MIME type, so by
default it is inherited from <code class="language-plaintext highlighter-rouge">#content_type</code> of the input file if available.
However, this attribute on uploaded files is set by Rack from the
<code class="language-plaintext highlighter-rouge">Content-Type</code> request header, which was set by the browser solely based on the
file extension.</p>

<p>This means that by default Shrine’s <code class="language-plaintext highlighter-rouge">mime_type</code> metadata is not guaranteed to
hold the actual MIME type of the file (e.g. the user can upload a PHP file with
a .jpg extension). This might sound like Shrine is not secure by deafult, but
you do get a warning in the console when <code class="language-plaintext highlighter-rouge">#content_type</code> is used. And in some
scenarios this might be exactly what you want.</p>

<p>Shrine comes with a <code class="language-plaintext highlighter-rouge">determine_mime_type</code> plugin, which determines MIME type
from file <em>content</em>. It uses tools that know how to read “magic headers” of
files, and saves the result into <code class="language-plaintext highlighter-rouge">mime_type</code> (which can then be
<a href="https://github.com/shrinerb/shrine#validation">validated</a>).</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"marcel"</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:determine_mime_type</span><span class="p">,</span> <span class="ss">analyzer: :marcel</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">File</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"image.png"</span><span class="p">,</span> <span class="s2">"&lt;?php ... ?&gt;"</span><span class="p">)</span> <span class="c1"># PHP file with a .png extension</span>
<span class="n">uploaded_file</span> <span class="o">=</span> <span class="n">uploader</span><span class="p">.</span><span class="nf">upload</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"image.png"</span><span class="p">))</span>
<span class="n">uploaded_file</span><span class="p">.</span><span class="nf">mime_type</span> <span class="c1">#=&gt; "text/x-php"</span>
</code></pre></div></div>

<p>If the <code class="language-plaintext highlighter-rouge">:marcel</code> analyzer doesn’t suit you, you can choose a different
analyzer, or even combine them:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Shrine</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:determine_mime_type</span><span class="p">,</span> <span class="ss">analyzer: </span><span class="o">-&gt;</span> <span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">analyzers</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">analyzers</span><span class="p">[</span><span class="ss">:mimemagic</span><span class="p">].</span><span class="nf">call</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="o">||</span> <span class="n">analyzers</span><span class="p">[</span><span class="ss">:file</span><span class="p">].</span><span class="nf">call</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="image-dimensions">Image Dimensions</h2>

<p>Image dimensions can be extracted by loading the <code class="language-plaintext highlighter-rouge">store_dimensions</code> plugin:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"fastimage"</span> <span class="c1"># default analyzer</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">Shrine</span>
  <span class="n">plugin</span> <span class="ss">:store_dimensions</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">image</span> <span class="o">=</span> <span class="n">image_uploader</span><span class="p">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="n">image</span><span class="p">.</span><span class="nf">metadata</span> <span class="c1">#=&gt;</span>
<span class="c1"># {</span>
<span class="c1">#   "filename" =&gt; "nature.jpg",</span>
<span class="c1">#   "mime_type" =&gt; "image/jpeg",</span>
<span class="c1">#   "size" =&gt; 90423,</span>
<span class="c1">#   "width" =&gt; 500,</span>
<span class="c1">#   "height" =&gt; 400,</span>
<span class="c1"># }</span>

<span class="n">image</span><span class="p">.</span><span class="nf">width</span>  <span class="c1">#=&gt; 500</span>
<span class="n">image</span><span class="p">.</span><span class="nf">height</span> <span class="c1">#=&gt; 400</span>

<span class="n">image</span><span class="p">.</span><span class="nf">dimensions</span> <span class="c1">#=&gt; [500, 400]</span>
</code></pre></div></div>

<h2 id="custom-metadata">Custom metadata</h2>

<p>In addition to built-in metadata, Shrine allows you to easily extract and save
<em>custom</em> metadata, with the <code class="language-plaintext highlighter-rouge">add_metadata</code> plugin.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DocumentUploader</span> <span class="o">&lt;</span> <span class="no">Shrine</span>
  <span class="n">plugin</span> <span class="ss">:add_metadata</span>

  <span class="n">add_metadata</span> <span class="ss">:pages</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
    <span class="no">PDF</span><span class="o">::</span><span class="no">Reader</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">path</span><span class="p">).</span><span class="nf">page_count</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pdf</span> <span class="o">=</span> <span class="n">document_uploader</span><span class="p">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span>
<span class="n">pdf</span><span class="p">.</span><span class="nf">metadata</span> <span class="c1">#=&gt;</span>
<span class="c1"># {</span>
<span class="c1">#   "filename" =&gt; "curriculum-vitae.pdf",</span>
<span class="c1">#   "mime_type" =&gt; "application/pdf",</span>
<span class="c1">#   "size" =&gt; 49234,</span>
<span class="c1">#   "pages" =&gt; 5</span>
<span class="c1"># }</span>
<span class="n">pdf</span><span class="p">.</span><span class="nf">pages</span> <span class="c1">#=&gt; 5</span>
</code></pre></div></div>

<p>Notice that it also generated a <code class="language-plaintext highlighter-rouge">#pages</code> reader method on the
<code class="language-plaintext highlighter-rouge">Shrine::UploadedFile</code> object. I think it’s nice to be able to extend Shrine
objects with methods that fit your domain.</p>

<p>If you’re using a tool which extracts multiple metadata at once, the
<code class="language-plaintext highlighter-rouge">add_metadata</code> plugin supports returning a hash as well.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">VideoUploader</span> <span class="o">&lt;</span> <span class="no">Shrine</span>
  <span class="n">plugin</span> <span class="ss">:add_metadata</span>

  <span class="n">add_metadata</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="no">FFMPEG</span><span class="o">::</span><span class="no">Movie</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nf">path</span><span class="p">)</span>

    <span class="p">{</span> <span class="s2">"duration"</span>   <span class="o">=&gt;</span> <span class="n">movie</span><span class="p">.</span><span class="nf">duration</span><span class="p">,</span>
      <span class="s2">"bitrate"</span>    <span class="o">=&gt;</span> <span class="n">movie</span><span class="p">.</span><span class="nf">bitrate</span><span class="p">,</span>
      <span class="s2">"resolution"</span> <span class="o">=&gt;</span> <span class="n">movie</span><span class="p">.</span><span class="nf">resolution</span><span class="p">,</span>
      <span class="s2">"frame_rate"</span> <span class="o">=&gt;</span> <span class="n">movie</span><span class="p">.</span><span class="nf">frame_rate</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">metadata_method</span> <span class="ss">:duration</span><span class="p">,</span> <span class="ss">:bitrate</span><span class="p">,</span> <span class="ss">:resolution</span><span class="p">,</span> <span class="ss">:frame_rate</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">video</span> <span class="o">=</span> <span class="n">video_uploader</span><span class="p">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<span class="n">video</span><span class="p">.</span><span class="nf">duration</span>   <span class="c1">#=&gt; 7.5</span>
<span class="n">video</span><span class="p">.</span><span class="nf">bitrate</span>    <span class="c1">#=&gt; 481</span>
<span class="n">video</span><span class="p">.</span><span class="nf">resolution</span> <span class="c1">#=&gt; "640x480"</span>
<span class="n">video</span><span class="p">.</span><span class="nf">frame_rate</span> <span class="c1">#=&gt; 16.72</span>
</code></pre></div></div>

<h2 id="storage-metadata">Storage metadata</h2>

<p>In addition to extracting the metadata on your side, Shrine also gives the
storage itself the ability to update the metadata after uploading. Some
storages like filesystem and Amazon S3 won’t use this, but many other storage
services extract file metadata during uploading.</p>

<p>For example, when you’re uploading images to Cloudinary, <a href="https://github.com/shrinerb/shrine-cloudinary">shrine-cloudinary</a>
will <a href="https://github.com/shrinerb/shrine-cloudinary/blob/c899875b935a45bc322a5e18be9c2132ebeecb4d/lib/shrine/storage/cloudinary.rb#L152-L157">automatically update</a> <code class="language-plaintext highlighter-rouge">size</code>, <code class="language-plaintext highlighter-rouge">mime_type</code>, <code class="language-plaintext highlighter-rouge">width</code>
and <code class="language-plaintext highlighter-rouge">height</code> metadata values. This is especially useful if you’re processing
the image on upload with Cloudinary, because then the metadata that Shrine
extracted won’t match the uploaded file, since those were extracted before the
upload.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">uploaded_file</span> <span class="o">=</span> <span class="n">cloudinary_uploader</span><span class="p">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="ss">upload_options: </span><span class="p">{</span>
  <span class="ss">format: </span><span class="s2">"png"</span><span class="p">,</span>
  <span class="ss">width:  </span><span class="mi">800</span><span class="p">,</span>
  <span class="ss">height: </span><span class="mi">800</span><span class="p">,</span>
  <span class="ss">crop:   :limit</span><span class="p">,</span>
<span class="p">})</span>

<span class="n">uploaded_file</span><span class="p">.</span><span class="nf">metadata</span> <span class="c1">#=&gt;</span>
<span class="c1"># {</span>
<span class="c1">#   "filename" =&gt; "nature.jpg"</span>
<span class="c1">#   "mime_type" =&gt; "image/png",</span>
<span class="c1">#   "size" =&gt; 8584,</span>
<span class="c1">#   "width" =&gt; 800,</span>
<span class="c1">#   "height" =&gt; 600,</span>
<span class="c1"># }</span>
</code></pre></div></div>

<p>Cloudinary also has the ability to automatically generate <a href="http://cloudinary.com/blog/introducing_intelligent_responsive_image_breakpoints_solutions">responsive
breakpoints</a>, and the ability to update the metadata allows the storage to
store the information about the generated breakpoints.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">uploaded_file</span> <span class="o">=</span> <span class="n">cloudinary_uploader</span><span class="p">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="ss">upload_options: </span><span class="p">{</span>
  <span class="ss">responsive_breakpoints: </span><span class="p">{</span>
    <span class="ss">bytes_step: </span><span class="mi">20000</span><span class="p">,</span>
    <span class="ss">min_width: </span><span class="mi">200</span><span class="p">,</span>
    <span class="ss">max_width: </span><span class="mi">1000</span><span class="p">,</span>
    <span class="ss">max_images: </span><span class="mi">20</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="n">uploaded_file</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="s2">"cloudinary"</span><span class="p">][</span><span class="s2">"responsive_breakpoints"</span><span class="p">]</span> <span class="c1">#=&gt;</span>
<span class="c1"># [{</span>
<span class="c1">#   "breakpoints": {</span>
<span class="c1">#     {</span>
<span class="c1">#       "width": 1000,</span>
<span class="c1">#       "height": 667,</span>
<span class="c1">#       "bytes": 79821,</span>
<span class="c1">#       "url": "http://res.cloudinary.com/demo/image/upload/c_scale,w_1000/v1453637947/dog.jpg",</span>
<span class="c1">#       "secure_url": "https://res.cloudinary.com/demo/image/upload/c_scale,w_1000/v1453637947/dog.jpg"</span>
<span class="c1">#     },</span>
<span class="c1">#     ...</span>
<span class="c1">#   }</span>
<span class="c1"># }]</span>
</code></pre></div></div>

<p>Some other storages that use the ability to update metadata include
<a href="https://github.com/shrinerb/shrine-flickr/blob/e0226bc4d2a316924d4690e5f0c1c21f613e44c1/lib/shrine/storage/flickr.rb#L114">shrine-flickr</a>, <a href="https://github.com/shrinerb/shrine-transloadit/blob/cd3b57aeeae3587852e2bab5f311b8f713f72fe5/lib/shrine/plugins/transloadit.rb#L150-L157">shrine-transloadit</a> and <a href="https://github.com/shrinerb/shrine-uploadcare/blob/c167516ba3002f7c880bfdea2e349731e7a7dddd/lib/shrine/storage/uploadcare.rb#L156-L165">shrine-uploadcare</a>.</p>

<h2 id="summary">Summary</h2>

<p>We’ve seen how Shrine automatically extracts metadata before upload, which is
then stored into the same database column. You can determine MIME type and
extract image dimensions from file content using a variety of tools, just by
loading a corresponding plugin. You can also extract any custom metadata, and
storage services can add their own metadata as well.</p>


  </div>
</article>

<div class="mt-10">
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'twinblog'; // required: replace example with your forum shortname
    var disqus_identifier = '/better-file-uploads-with-shrine-metadata';
    var disqus_url = 'https://janko.io/better-file-uploads-with-shrine-metadata/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

      </main>
    </div>

    
  </body>
</html>
